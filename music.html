<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>F音乐播放器</title>
        <style>
            /* 保持原有CSS不变 */
            :root {
                --primary-color: #e0e5ec;
                --secondary-color: #f9f9f9;
                --light-shadow: rgba(255, 255, 255, 0.5);
                --dark-shadow: rgba(163, 177, 198, 0.5);
                --accent-color: #6a7efc;
                --text-color: #4d4d4d;
                --active-color: #6a7efc;
                --inactive-color: #8a8a8a;
                --album-size: min(70vw, 300px);
                --radius: 10px;
                --font-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                --transition: all 0.3s ease;
                --progress-height: 6px;
                --progress-radius: 3px;
                --control-btn-size: 50px;
                --volume-slider-height: 4px;
                --volume-thumb-size: 16px;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: var(--font-base);
                -webkit-tap-highlight-color: transparent;
                transition: var(--transition);
            }

            html {
                width: 100vw;
                height: 100vh;
                overflow: hidden;
            }

            body {
                background-color: var(--primary-color);
                color: var(--text-color);
                height: 100%;
                width: 100%;
                display: grid;
                grid-template-rows: 1fr auto;
            }

            .man {
                width: 100%;
            }


            .tab {
                background: var(--secondary-color);
                border-radius: var(--radius);
                /* box-shadow: 10px 10px 20px var(--dark-shadow), -10px -10px 20px var(--light-shadow); */
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                padding: 10px;
            }

            .player-tab,
            .playlist-tab,
            .source-tab {
                display: grid;
                gap: 25px;
                padding: 20px;
            }

            .player-content,
            .progress-content,
            .control-content,
            .volume-content {
                border-radius: var(--radius);
                text-align: center;
            }

            .player-header {
                font-size: 1.5rem;
                font-weight: 600;
                color: #000;
                margin-bottom: 15px;
            }

            .album-art-container {
                width: var(--album-size);
                height: var(--album-size);
                border-radius: 50%;
                overflow: hidden;
                box-shadow: 10px 10px 20px var(--dark-shadow), -10px -10px 20px var(--light-shadow);
                margin: 10px auto;
                animation: rotate 8s linear infinite;
            }

            .album-art-container.paused {
                animation-play-state: paused;
            }

            .album-art img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .song-info {
                color: var(--inactive-color);
                font-size: 1.125rem;
                font-weight: 500;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
                margin: 15px 0;
            }

            .progress-content {
                width: 100%;
                max-width: 400px;
                padding: 0 10px;
                margin: 0 auto;
            }

            .progress-container {
                width: 100%;
                height: var(--progress-height);
                background: #d1d9e6;
                border-radius: var(--progress-radius);
                box-shadow: inset 2px 2px 5px var(--dark-shadow),
                    inset -2px -2px 5px var(--light-shadow);
                cursor: pointer;
                position: relative;
                margin: 10px auto;
            }

            .progress-bar {
                height: 100%;
                background: var(--accent-color);
                box-shadow: 2px 2px 4px var(--dark-shadow);
                border-radius: var(--progress-radius);
                transition: width 0.3s ease;
            }

            .time-display {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
                margin-top: 5px;
            }

            .control-content {
                width: 100%;
                max-width: 400px;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                margin: 10px auto;
            }

            .control-btn {
                width: var(--control-btn-size);
                height: var(--control-btn-size);
                border-radius: 50%;
                background: var(--primary-color);
                border: none;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                box-shadow: 5px 5px 10px var(--dark-shadow),
                    -5px -5px 10px var(--light-shadow);
                transition: var(--transition);
                color: var(--text-color);
                font-size: 18px;
            }

            .control-btn:hover {
                box-shadow: inset 2px 2px 5px var(--dark-shadow),
                    inset -2px -2px 5px var(--light-shadow);
            }

            .control-btn:active {
                transform: scale(0.95);
            }

            .control-btn.active {
                color: var(--accent-color);
                box-shadow: inset 2px 2px 5px var(--dark-shadow),
                    inset -2px -2px 5px var(--light-shadow);
            }

            .play-btn {
                font-size: 1.6rem;
                width: calc(var(--control-btn-size) * 1.2);
                height: calc(var(--control-btn-size) * 1.2);
            }

            .volume-content {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 0 20px;
                max-width: 400px;
                margin: 0 auto;
            }

            .volume-slider {
                -webkit-appearance: none;
                width: 100%;
                height: var(--volume-slider-height);
                background: var(--inactive-color);
                outline: none;
                border-radius: 2px;
            }

            .volume-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: var(--volume-thumb-size);
                height: var(--volume-thumb-size);
                background: var(--accent-color);
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                cursor: pointer;
            }

            .volume-icon {
                font-size: 16px;
                color: #000000;
                min-width: 20px;
            }

            .tab-item {
                text-align: center;
                cursor: pointer;
                color: var(--inactive-color);
                font-size: 0.8rem;
                transition: var(--transition);
                border-radius: var(--radius);
            }

            .tab-item.active {
                color: var(--active-color);
                font-weight: 500;
            }

            .tab-icon {
                font-size: 1.2rem;
                margin-bottom: 4px;
            }

            .playlist-tab {
                display: none;
            }

            .playlist {
                max-height: 60vh;
                overflow-y: auto;
                padding: 10px;
                border-radius: var(--radius);
                background: var(--secondary-color);
                box-shadow: inset 2px 2px 5px var(--dark-shadow),
                    inset -2px -2px 5px var(--light-shadow);
            }

            .playlist-item {
                display: grid;
                grid-template-columns: 50px 1fr auto;
                gap: 15px;
                align-items: center;
                padding: 10px;
                border-radius: var(--radius);
                margin-bottom: 8px;
                background: var(--primary-color);
                box-shadow: 3px 3px 6px var(--dark-shadow),
                    -3px -3px 6px var(--light-shadow);
                cursor: pointer;
                transition: var(--transition);
            }

            .playlist-item:hover {
                transform: translateY(-2px);
                box-shadow: 5px 5px 10px var(--dark-shadow),
                    -5px -5px 10px var(--light-shadow);
            }

            .playlist-item img {
                width: 50px;
                height: 50px;
                border-radius: 5px;
                object-fit: cover;
            }

            .playlist-item.active {
                background-color: rgba(106, 126, 252, 0.1);
                border-left: 3px solid var(--accent-color);
            }

            .playlist-item-title {
                font-weight: 600;
                margin-bottom: 3px;
            }

            .playlist-item-artist {
                font-size: 0.85rem;
                color: var(--inactive-color);
            }

            .playlist-item-duration {
                color: var(--inactive-color);
                font-size: 0.9rem;
            }

            .empty-message {
                text-align: center;
                padding: 20px;
                color: var(--inactive-color);
            }

            .source-tab {
                display: none;
            }

            .source-container {
                display: grid;
                gap: 30px;
                max-width: 600px;
                margin: 0 auto;
            }

            .source-section {
                background: var(--secondary-color);
                border-radius: var(--radius);
                padding: 20px;
                box-shadow: 5px 5px 15px var(--dark-shadow),
                    -5px -5px 15px var(--light-shadow);
            }

            .source-title {
                font-size: 1.2rem;
                font-weight: 600;
                margin-bottom: 15px;
                color: #000;
            }

            .input-group {
                margin-bottom: 15px;
            }

            .url-input {
                width: 100%;
                padding: 12px 15px;
                border: none;
                border-radius: var(--radius);
                background: var(--primary-color);
                box-shadow: inset 2px 2px 5px var(--dark-shadow),
                    inset -2px -2px 5px var(--light-shadow);
                font-size: 1rem;
            }

            .url-input:focus {
                outline: none;
                box-shadow: inset 2px 2px 5px var(--dark-shadow),
                    inset -2px -2px 5px var(--light-shadow),
                    0 0 0 2px var(--accent-color);
            }

            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 12px 25px;
                background: var(--accent-color);
                color: white;
                border: none;
                border-radius: var(--radius);
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                box-shadow: 5px 5px 10px var(--dark-shadow),
                    -5px -5px 10px var(--light-shadow);
                transition: var(--transition);
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 7px 7px 15px var(--dark-shadow),
                    -7px -7px 15px var(--light-shadow);
            }

            .btn:active {
                transform: translateY(0);
                box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.2),
                    inset -2px -2px 5px rgba(255, 255, 255, 0.5);
            }

            .info-text {
                margin-top: 15px;
                font-size: 0.85rem;
                color: var(--inactive-color);
                line-height: 1.4;
            }

            .permission-request {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }

            .permission-box {
                background: var(--secondary-color);
                border-radius: var(--radius);
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }

            .permission-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 15px;
                text-align: center;
            }

            .permission-text {
                margin-bottom: 25px;
                line-height: 1.6;
                text-align: center;
            }

            .permission-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
            }

            .permission-btn {
                padding: 12px 30px;
                border: none;
                border-radius: var(--radius);
                font-weight: 500;
                cursor: pointer;
                transition: var(--transition);
                box-shadow: 3px 3px 8px var(--dark-shadow),
                    -3px -3px 8px var(--light-shadow);
            }

            .allow {
                background: var(--accent-color);
                color: white;
            }

            .deny {
                background: var(--primary-color);
                color: var(--text-color);
            }

            .permission-btn:hover {
                transform: translateY(-2px);
            }

            .permission-btn:active {
                transform: translateY(0);
            }

            .notification {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 25px;
                border-radius: 30px;
                font-size: 0.9rem;
                z-index: 1000;
                opacity: 0;
                transition: transform 0.3s ease, opacity 0.3s ease;
            }

            .notification.show {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }

            @keyframes rotate {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s linear infinite;
                margin-left: 10px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>

    <body>
        <!-- 主内容区域 -->
        <div class="main">
            <!-- 播放器标签页 -->
            <div class="player-tab" id="player-tab">
                <div class="player-content">
                    <div class="player-header">F音乐播放器</div>
                    <div class="album-art-container">
                        <div class="album-art">
                            <img src="https://picsum.photos/400/400" alt="Album Art" id="albumArt">
                        </div>
                    </div>
                    <div class="song-info">
                        <div class="song-title" id="songTitle">歌曲名称</div>
                        <div class="song-artist" id="songArtist">艺术家</div>
                    </div>
                </div>

                <div class="progress-content">
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>

                <div class="control-content">
                    <button class="control-btn" id="shuffleBtn" title="随机播放">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn" id="prevBtn" title="上一曲">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-btn" id="playBtn" title="播放/暂停">
                        <i class="fas fa-play" id="playIcon"></i>
                    </button>
                    <button class="control-btn" id="nextBtn" title="下一曲">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn" id="repeatBtn" title="循环播放">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>

                <div class="volume-content">
                    <i class="fas fa-volume-up volume-icon"></i>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
                </div>
            </div>

            <!-- 播放列表标签页 -->
            <div class="playlist-tab" id="playlist-tab" style="display: none;">
                <div class="playlist" id="playlist">
                    <div class="empty-message">暂无歌曲，请先添加音乐源</div>
                </div>
            </div>

            <!-- 音乐源标签页 -->
            <div class="source-tab" id="source-tab" style="display: none;">
                <div class="source-container">
                    <div class="source-section">
                        <div class="source-title">从API获取音乐</div>
                        <div class="input-group">
                            <input type="text" class="url-input" id="apiUrlInput"
                                placeholder="输入API地址 (例如: http://localhost:3000/api/songs)">
                        </div>
                        <button class="btn btn-primary" id="fetchApiBtn">
                            <span id="fetchApiText">获取歌曲</span>
                            <span id="fetchApiSpinner" class="loading" style="display: none;"></span>
                        </button>
                        <div class="info-text">API应返回包含title, artist, src, cover, duration字段的JSON数组</div>
                    </div>

                    <div class="source-section">
                        <div class="source-title">从本地文件夹获取</div>
                        <input type="file" id="fileInput" webkitdirectory directory multiple class="file-input"
                            accept="audio/*">
                        <button class="btn btn-primary" id="selectFolderBtn">
                            <span id="selectFolderText">选择文件夹</span>
                            <span id="selectFolderSpinner" class="loading" style="display: none;"></span>
                        </button>
                        <div class="info-text">支持MP3、WAV、OGG等音频文件，将自动解析元数据获取歌曲信息</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部标签栏 -->
        <div class="tab">
            <div class="tab-item active" data-tab="player-tab">
                <div class="tab-icon"><i class="fas fa-music"></i></div>
                <div>播放器</div>
            </div>
            <div class="tab-item" data-tab="playlist-tab">
                <div class="tab-icon"><i class="fas fa-list"></i></div>
                <div>播放列表</div>
            </div>
            <div class="tab-item" data-tab="source-tab">
                <div class="tab-icon"><i class="fas fa-database"></i></div>
                <div>音乐源</div>
            </div>
        </div>

        <!-- 权限请求对话框 -->
        <div class="permission-request" id="permissionRequest" style="display: none;">
            <div class="permission-box">
                <div class="permission-title">文件访问权限</div>
                <div class="permission-text">
                    为了在下次打开时自动加载您的音乐，我们需要保存文件访问权限。您允许我们记住您选择的音乐文件夹吗？
                </div>
                <div class="permission-buttons">
                    <button class="permission-btn allow" id="allowPermission">允许</button>
                    <button class="permission-btn deny" id="denyPermission">拒绝</button>
                </div>
            </div>
        </div>

        <!-- 通知区域 -->
        <div class="notification" id="notification"></div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // =============================================
                // 音乐播放器模块
                // =============================================
                const MusicPlayer = {
                    // DOM元素缓存
                    elements: {
                        albumArt: document.getElementById('albumArt'),
                        songTitle: document.getElementById('songTitle'),
                        songArtist: document.getElementById('songArtist'),
                        progressBar: document.getElementById('progressBar'),
                        progressContainer: document.getElementById('progressContainer'),
                        currentTime: document.getElementById('currentTime'),
                        duration: document.getElementById('duration'),
                        playBtn: document.getElementById('playBtn'),
                        playIcon: document.getElementById('playIcon'),
                        prevBtn: document.getElementById('prevBtn'),
                        nextBtn: document.getElementById('nextBtn'),
                        volumeSlider: document.getElementById('volumeSlider'),
                        playlist: document.getElementById('playlist'),
                        shuffleBtn: document.getElementById('shuffleBtn'),
                        repeatBtn: document.getElementById('repeatBtn'),
                        tabItems: document.querySelectorAll('.tab-item'),
                        apiUrlInput: document.getElementById('apiUrlInput'),
                        fetchApiBtn: document.getElementById('fetchApiBtn'),
                        fetchApiText: document.getElementById('fetchApiText'),
                        fetchApiSpinner: document.getElementById('fetchApiSpinner'),
                        fileInput: document.getElementById('fileInput'),
                        selectFolderBtn: document.getElementById('selectFolderBtn'),
                        selectFolderText: document.getElementById('selectFolderText'),
                        selectFolderSpinner: document.getElementById('selectFolderSpinner'),
                        notification: document.getElementById('notification'),
                        permissionRequest: document.getElementById('permissionRequest'),
                        allowPermissionBtn: document.getElementById('allowPermission'),
                        denyPermissionBtn: document.getElementById('denyPermission')
                    },

                    // 状态变量
                    audio: new Audio(),
                    isPlaying: false,
                    currentSongIndex: 0,
                    isShuffle: false,
                    isRepeat: false,
                    songs: [],
                    originalPlaylist: [],
                    fileHandles: [],

                    // 初始化播放器
                    init() {
                        this.setupEventListeners();
                        this.audio.volume = this.elements.volumeSlider.value;
                        this.loadSavedSongs();
                    },

                    // 设置事件监听器
                    setupEventListeners() {
                        // 播放控制
                        this.elements.playBtn.addEventListener('click', () => this.togglePlay());
                        this.elements.prevBtn.addEventListener('click', () => this.prevSong());
                        this.elements.nextBtn.addEventListener('click', () => this.nextSong());
                        this.elements.volumeSlider.addEventListener('input', () => this.setVolume());
                        this.elements.progressContainer.addEventListener('click', (e) => this.setProgress(e));
                        this.elements.shuffleBtn.addEventListener('click', () => this.toggleShuffle());
                        this.elements.repeatBtn.addEventListener('click', () => this.toggleRepeat());

                        // 标签切换
                        this.elements.tabItems.forEach(item => {
                            item.addEventListener('click', () => this.switchTab(item.dataset.tab));
                        });

                        // 音乐源相关
                        this.elements.fetchApiBtn.addEventListener('click', () => this.fetchSongsFromApi());
                        this.elements.selectFolderBtn.addEventListener('click', () => this.elements.fileInput.click());
                        this.elements.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                        this.elements.allowPermissionBtn.addEventListener('click', () => this.allowPermission());
                        this.elements.denyPermissionBtn.addEventListener('click', () => this.denyPermission());

                        // 音频事件
                        this.audio.addEventListener('timeupdate', () => this.updateProgress());
                        this.audio.addEventListener('ended', () => this.handleSongEnd());
                        this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
                        this.audio.addEventListener('error', () => this.handleAudioError());

                        // 播放列表事件委托
                        this.elements.playlist.addEventListener('click', (e) => {
                            const playlistItem = e.target.closest('.playlist-item');
                            if (playlistItem) {
                                const index = parseInt(playlistItem.dataset.index);
                                this.playSongFromPlaylist(index);
                            }
                        });
                    },

                    // =============================================
                    // 播放控制功能
                    // =============================================

                    // 播放/暂停切换
                    togglePlay() {
                        if (this.songs.length === 0) {
                            this.showNotification('请先添加歌曲');
                            return;
                        }

                        if (this.isPlaying) {
                            this.pauseSong();
                        } else {
                            this.playSong();
                        }
                    },

                    // 播放歌曲
                    playSong() {
                        this.isPlaying = true;
                        this.elements.playIcon.classList.replace('fa-play', 'fa-pause');
                        this.elements.albumArt.parentElement.classList.remove('paused');

                        this.audio.play().catch(error => {
                            console.error('播放失败:', error);
                            this.isPlaying = false;
                            this.elements.playIcon.classList.replace('fa-pause', 'fa-play');
                            this.elements.albumArt.parentElement.classList.add('paused');
                            this.showNotification('播放失败: ' + error.message);
                        });
                    },

                    // 暂停歌曲
                    pauseSong() {
                        this.isPlaying = false;
                        this.elements.playIcon.classList.replace('fa-pause', 'fa-play');
                        this.elements.albumArt.parentElement.classList.add('paused');
                        this.audio.pause();
                    },

                    // 上一曲
                    prevSong() {
                        if (this.songs.length === 0) return;

                        this.currentSongIndex = (this.currentSongIndex - 1 + this.songs.length) % this.songs.length;
                        this.loadSong(this.currentSongIndex);
                        if (this.isPlaying) this.playSong();
                        this.updateActiveSong();
                    },

                    // 下一曲
                    nextSong() {
                        if (this.songs.length === 0) return;

                        this.currentSongIndex = (this.currentSongIndex + 1) % this.songs.length;
                        this.loadSong(this.currentSongIndex);
                        if (this.isPlaying) this.playSong();
                        this.updateActiveSong();
                    },

                    // 歌曲结束处理
                    handleSongEnd() {
                        if (this.isRepeat) {
                            this.audio.currentTime = 0;
                            this.audio.play();
                        } else {
                            this.nextSong();
                        }
                    },

                    // =============================================
                    // 播放列表管理
                    // =============================================

                    // 加载歌曲
                    loadSong(index) {
                        if (!this.songs || this.songs.length === 0) return;

                        const song = this.songs[index];
                        this.audio.src = song.src;
                        this.elements.albumArt.src = song.cover;
                        this.elements.songTitle.textContent = song.title;
                        this.elements.songArtist.textContent = song.artist;

                        // 重置旋转动画
                        const albumContainer = this.elements.albumArt.parentElement.parentElement;
                        albumContainer.classList.remove('paused');
                        void albumContainer.offsetWidth; // 触发重绘

                        if (!this.isPlaying) {
                            albumContainer.classList.add('paused');
                        }

                        // 保存当前播放列表
                        this.savePlaylist();
                    },

                    // 从播放列表播放歌曲
                    playSongFromPlaylist(index) {
                        this.currentSongIndex = index;
                        this.loadSong(this.currentSongIndex);
                        this.playSong();
                        this.updateActiveSong();
                        this.switchTab('player-tab');
                    },

                    // 更新活动歌曲样式
                    updateActiveSong() {
                        const playlistItems = this.elements.playlist.querySelectorAll('.playlist-item');
                        playlistItems.forEach((item, index) => {
                            item.classList.toggle('active', index === this.currentSongIndex);
                        });
                    },

                    // 渲染播放列表
                    renderPlaylist() {
                        if (!this.songs || this.songs.length === 0) {
                            this.elements.playlist.innerHTML = '<div class="empty-message">暂无歌曲，请先添加音乐源</div>';
                            return;
                        }

                        this.elements.playlist.innerHTML = '';
                        this.songs.forEach((song, index) => {
                            const playlistItem = document.createElement('div');
                            playlistItem.className = 'playlist-item';
                            playlistItem.dataset.index = index;
                            playlistItem.innerHTML = `
                            <img src="${ song.cover }" alt="${ song.title }">
                            <div class="playlist-item-info">
                                <div class="playlist-item-title">${ song.title }</div>
                                <div class="playlist-item-artist">${ song.artist }</div>
                            </div>
                            <div class="playlist-item-duration">${ song.duration }</div>
                        `;
                            this.elements.playlist.appendChild(playlistItem);
                        });

                        this.updateActiveSong();
                    },

                    // =============================================
                    // 进度和音量控制
                    // =============================================

                    // 更新进度条
                    updateProgress() {
                        const { duration, currentTime } = this.audio;
                        const progressPercent = (currentTime / duration) * 100;
                        this.elements.progressBar.style.width = `${ progressPercent }%`;
                        this.elements.currentTime.textContent = this.formatTime(currentTime);
                    },

                    // 设置进度
                    setProgress(e) {
                        const width = this.elements.progressContainer.clientWidth;
                        const clickX = e.offsetX;
                        const duration = this.audio.duration;
                        this.audio.currentTime = (clickX / width) * duration;
                    },

                    // 更新歌曲总时长
                    updateDuration() {
                        if (!isNaN(this.audio.duration)) {
                            this.elements.duration.textContent = this.formatTime(this.audio.duration);

                            // 更新播放列表中歌曲的时长
                            if (this.songs[this.currentSongIndex]) {
                                this.songs[this.currentSongIndex].duration = this.formatTime(this.audio.duration);
                                const playlistItems = this.elements.playlist.querySelectorAll('.playlist-item');
                                if (playlistItems[this.currentSongIndex]) {
                                    const durationEl = playlistItems[this.currentSongIndex].querySelector('.playlist-item-duration');
                                    if (durationEl) {
                                        durationEl.textContent = this.formatTime(this.audio.duration);
                                    }
                                }
                            }
                        }
                    },

                    // 设置音量
                    setVolume() {
                        this.audio.volume = this.elements.volumeSlider.value;
                    },

                    // =============================================
                    // 播放模式控制
                    // =============================================

                    // 切换随机播放
                    toggleShuffle() {
                        if (this.songs.length === 0) {
                            this.showNotification('请先添加歌曲');
                            return;
                        }

                        this.isShuffle = !this.isShuffle;
                        this.elements.shuffleBtn.classList.toggle('active', this.isShuffle);

                        if (this.isShuffle) {
                            // 保存当前歌曲
                            const currentSong = this.songs[this.currentSongIndex];

                            // Fisher-Yates 洗牌算法
                            for (let i = this.songs.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [this.songs[i], this.songs[j]] = [this.songs[j], this.songs[i]];
                            }

                            // 将当前歌曲移到第一位
                            const newIndex = this.songs.indexOf(currentSong);
                            if (newIndex > 0) {
                                [this.songs[0], this.songs[newIndex]] = [this.songs[newIndex], this.songs[0]];
                            }

                            this.currentSongIndex = 0;
                            this.showNotification('随机播放已开启');
                        } else {
                            // 恢复原始顺序
                            this.songs = [...this.originalPlaylist];
                            this.currentSongIndex = this.songs.findIndex(song =>
                                song.title === this.elements.songTitle.textContent &&
                                song.artist === this.elements.songArtist.textContent
                            );
                            if (this.currentSongIndex === -1) this.currentSongIndex = 0;
                            this.showNotification('随机播放已关闭');
                        }

                        this.renderPlaylist();
                        this.updateActiveSong();
                        this.savePlaylist();
                    },

                    // 切换循环播放
                    toggleRepeat() {
                        this.isRepeat = !this.isRepeat;
                        this.elements.repeatBtn.classList.toggle('active', this.isRepeat);
                        this.showNotification(this.isRepeat ? '循环播放已开启' : '循环播放已关闭');
                    },

                    // =============================================
                    // 音乐源管理
                    // =============================================

                    // 从API获取歌曲
                    async fetchSongsFromApi() {
                        const apiUrl = this.elements.apiUrlInput.value.trim();
                        if (!apiUrl) {
                            this.showNotification('请输入API地址');
                            return;
                        }

                        try {
                            // 显示加载状态
                            this.elements.fetchApiText.textContent = '加载中...';
                            this.elements.fetchApiSpinner.style.display = 'inline-block';
                            this.elements.fetchApiBtn.disabled = true;

                            const response = await fetch(apiUrl);
                            if (!response.ok) throw new Error(`请求失败: ${ response.status }`);

                            const data = await response.json();
                            if (!Array.isArray(data)) throw new Error('API返回的数据不是数组');

                            // 验证必要字段
                            const requiredFields = ['title', 'artist', 'src'];
                            const isValid = data.every(song =>
                                requiredFields.every(field => field in song)
                            );

                            if (!isValid) throw new Error('歌曲数据缺少必要字段');

                            this.songs = data.map(song => ({
                                title: song.title || '未知歌曲',
                                artist: song.artist || '未知艺术家',
                                src: song.src,
                                cover: song.cover || this.generateRandomCover(),
                                duration: song.duration || '0:00'
                            }));

                            this.originalPlaylist = [...this.songs];
                            this.currentSongIndex = 0;

                            this.loadSong(this.currentSongIndex);
                            this.renderPlaylist();
                            this.updateActiveSong();
                            this.switchTab('player-tab');

                            // 保存API地址
                            localStorage.setItem('musicPlayerApiUrl', apiUrl);

                            this.showNotification(`成功加载 ${ this.songs.length } 首歌曲`);
                        } catch (error) {
                            console.error('获取歌曲时出错:', error);
                            this.showNotification('获取歌曲失败: ' + error.message);
                        } finally {
                            // 重置按钮状态
                            this.elements.fetchApiText.textContent = '获取歌曲';
                            this.elements.fetchApiSpinner.style.display = 'none';
                            this.elements.fetchApiBtn.disabled = false;
                        }
                    },

                    // 处理本地文件夹选择
                    async handleFileSelect(event) {
                        const files = Array.from(event.target.files);
                        const audioFiles = files.filter(file => file.type.startsWith('audio/'));

                        if (audioFiles.length === 0) {
                            this.showNotification('未找到音频文件');
                            return;
                        }

                        try {
                            // 显示加载状态
                            this.elements.selectFolderText.textContent = '解析中...';
                            this.elements.selectFolderSpinner.style.display = 'inline-block';
                            this.elements.selectFolderBtn.disabled = true;

                            // 解析音频文件
                            this.songs = await Promise.all(audioFiles.map(file => this.parseAudioFile(file)));
                            this.originalPlaylist = [...this.songs];
                            this.currentSongIndex = 0;

                            this.loadSong(this.currentSongIndex);
                            this.renderPlaylist();
                            this.updateActiveSong();
                            this.switchTab('player-tab');

                            this.showNotification(`成功加载 ${ this.songs.length } 首歌曲`);

                            // 检查是否已经获得权限
                            const hasPermission = localStorage.getItem('musicPlayerPermission') === 'granted';

                            // 如果没有权限，显示权限请求
                            if (!hasPermission && window.showDirectoryPicker) {
                                this.elements.permissionRequest.style.display = 'flex';
                            }
                        } catch (error) {
                            console.error('解析音频文件时出错:', error);
                            this.showNotification('加载音频文件失败: ' + error.message);
                        } finally {
                            // 重置按钮状态
                            this.elements.selectFolderText.textContent = '选择文件夹';
                            this.elements.selectFolderSpinner.style.display = 'none';
                            this.elements.selectFolderBtn.disabled = false;
                        }
                    },

                    // 解析音频文件获取元数据
                    parseAudioFile(file) {
                        return new Promise((resolve) => {
                            const url = URL.createObjectURL(file);
                            const audio = new Audio();

                            const onLoaded = () => {
                                const duration = this.formatTime(audio.duration);
                                const [artist, title] = this.parseFileName(file.name);
                                resolve({
                                    title: title || file.name.replace(/\.[^/.]+$/, ""),
                                    artist: artist || '未知艺术家',
                                    src: url,
                                    cover: this.generateRandomCover(),
                                    duration: duration,
                                    file: file
                                });

                                // 清理
                                audio.removeEventListener('error', onError);
                                URL.revokeObjectURL(url);
                            };

                            const onError = () => {
                                resolve({
                                    title: file.name.replace(/\.[^/.]+$/, ""),
                                    artist: '未知艺术家',
                                    src: url,
                                    cover: this.generateRandomCover(),
                                    duration: '0:00',
                                    file: file
                                });

                                // 清理
                                audio.removeEventListener('loadedmetadata', onLoaded);
                                URL.revokeObjectURL(url);
                            };

                            audio.src = url;
                            audio.addEventListener('loadedmetadata', onLoaded, { once: true });
                            audio.addEventListener('error', onError, { once: true });
                        });
                    },

                    // =============================================
                    // 权限管理
                    // =============================================

                    // 允许权限
                    async allowPermission() {
                        try {
                            this.elements.permissionRequest.style.display = 'none';

                            // 使用File System Access API获取目录句柄
                            if (window.showDirectoryPicker) {
                                const directoryHandle = await window.showDirectoryPicker({
                                    mode: 'read'
                                });

                                // 保存目录句柄
                                localStorage.setItem('musicPlayerPermission', 'granted');
                                localStorage.setItem('musicPlayerDirectory', JSON.stringify({
                                    name: directoryHandle.name
                                }));

                                // 存储句柄以便后续使用
                                this.fileHandles = [directoryHandle];

                                this.showNotification('已获得文件夹访问权限');
                            }
                        } catch (error) {
                            console.error('获取目录权限时出错:', error);
                            this.showNotification('获取权限失败: ' + error.message);
                        }
                    },

                    // 拒绝权限
                    denyPermission() {
                        this.elements.permissionRequest.style.display = 'none';
                        localStorage.setItem('musicPlayerPermission', 'denied');
                        this.showNotification('您拒绝了文件夹访问权限');
                    },

                    // =============================================
                    // 工具函数
                    // =============================================

                    // 生成随机封面
                    generateRandomCover() {
                        return `https://picsum.photos/200/200?random=${ Math.floor(Math.random() * 1000) }`;
                    },

                    // 格式化时间
                    formatTime(seconds) {
                        if (isNaN(seconds)) return '0:00';
                        const minutes = Math.floor(seconds / 60);
                        const secs = Math.floor(seconds % 60);
                        return `${ minutes }:${ secs < 10 ? '0' : '' }${ secs }`;
                    },

                    // 解析文件名
                    parseFileName(filename) {
                        const baseName = filename.replace(/\.[^/.]+$/, "");
                        return baseName.split(' - ').map(s => s.trim());
                    },

                    // 显示通知
                    showNotification(message, duration = 3000) {
                        this.elements.notification.textContent = message;
                        this.elements.notification.classList.add('show');

                        setTimeout(() => {
                            this.elements.notification.classList.remove('show');
                        }, duration);
                    },

                    // 处理音频错误
                    handleAudioError() {
                        console.error('音频加载错误:', this.audio.error);
                        this.showNotification('音频加载失败，请尝试播放其他歌曲');
                        this.nextSong();
                    },

                    // 切换标签页
                    switchTab(tabId) {
                        this.elements.tabItems.forEach(item => {
                            item.classList.toggle('active', item.dataset.tab === tabId);
                        });

                        // 显示/隐藏标签内容
                        document.querySelectorAll('.player-tab, .playlist-tab, .source-tab').forEach(tab => {
                            tab.style.display = tab.id === tabId ? 'grid' : 'none';
                        });
                    },

                    // 保存播放列表到本地存储
                    savePlaylist() {
                        try {
                            // 只保存必要信息，避免存储整个文件对象
                            const playlistToSave = this.songs.map(song => ({
                                title: song.title,
                                artist: song.artist,
                                src: song.src,
                                cover: song.cover,
                                duration: song.duration
                            }));

                            localStorage.setItem('musicPlayerSongs', JSON.stringify(playlistToSave));
                        } catch (error) {
                            console.error('保存播放列表时出错:', error);
                        }
                    },

                    // 加载保存的歌曲
                    async loadSavedSongs() {
                        try {
                            const savedPermission = localStorage.getItem('musicPlayerPermission');

                            // 如果用户之前拒绝了权限，不再尝试加载
                            if (savedPermission === 'denied') return;

                            // 检查是否有保存的歌曲数据
                            const savedSongs = localStorage.getItem('musicPlayerSongs');
                            if (savedSongs) {
                                this.songs = JSON.parse(savedSongs);
                                this.originalPlaylist = [...this.songs];

                                if (this.songs.length > 0) {
                                    this.currentSongIndex = 0;
                                    this.loadSong(this.currentSongIndex);
                                    this.renderPlaylist();
                                    this.updateActiveSong();
                                    this.showNotification(`已加载上次的 ${ this.songs.length } 首歌曲`);
                                }
                            }

                            // 尝试重新获取目录访问权限
                            if (savedPermission === 'granted' && window.showDirectoryPicker) {
                                try {
                                    const directoryHandle = await window.showDirectoryPicker({
                                        mode: 'read'
                                    });
                                    this.fileHandles = [directoryHandle];
                                } catch (error) {
                                    console.error('重新获取目录权限时出错:', error);
                                    localStorage.removeItem('musicPlayerPermission');
                                }
                            }
                        } catch (error) {
                            console.error('加载保存的歌曲时出错:', error);
                        }
                    }
                };

                // 初始化音乐播放器
                MusicPlayer.init();
            });
        </script>
    </body>

</html>