<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>音乐播放器</title>
        <style>
            :root {
                --primary-color: #e0e5ec;
                --shadow-light: rgba(255, 255, 255, 0.5);
                --shadow-dark: rgba(163, 177, 198, 0.5);
                --accent-color: #6a7efc;
                --text-color: #4d4d4d;
                --tab-active-color: #6a7efc;
                --tab-inactive-color: #8a8a8a;
                --album-art-size: min(70vw, 300px);
                --background-color: #e0e5ec;
                --card-color: #e0e5ec;
                --text-primary: #4d4d4d;
                --text-secondary: #666;
            }

            /* 深色主题变量 */
            .dark-mode {
                --primary-color: #2a2e35;
                --shadow-light: rgba(0, 0, 0, 0.2);
                --shadow-dark: rgba(0, 0, 0, 0.5);
                --accent-color: #6a7efc;
                --text-color: #f0f0f0;
                --tab-active-color: #6a7efc;
                --tab-inactive-color: #aaa;
                --background-color: #1e2025;
                --card-color: #2a2e35;
                --text-primary: #f0f0f0;
                --text-secondary: #ccc;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                background-color: var(--background-color);
                color: var(--text-primary);
                min-height: 100vh;
                display: grid;
                grid-template-rows: 1fr auto;
                overflow: hidden;
                transition: background-color 0.3s, color 0.3s;
            }

            /* 主内容容器 */
            .main-content {
                display: grid;
                grid-template-rows: 1fr;
                overflow: hidden;
                position: relative;
            }

            /* 标签内容容器 */
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 15px;
                overflow-y: auto;
                display: none;
                -webkit-overflow-scrolling: touch;
            }

            .tab-content.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            /* 底部标签栏 */
            .tab-bar {
                display: flex;
                width: 100%;
                max-width: 600px;
                height: 60px;
                margin: 0 auto;
                background-color: var(--primary-color);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                z-index: 10;
            }

            .tab-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: var(--tab-inactive-color);
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .tab-item.active {
                color: var(--tab-active-color);
            }

            .tab-icon {
                font-size: 22px;
                margin-bottom: 3px;
            }

            /* 播放器样式 */
            .player-container {
                display: flex;
                flex-direction: column;
                height: 100%;
                align-items: center;
                justify-content: center;
                padding: 15px;
            }

            .album-art-container {
                display: flex;
                justify-content: center;
                margin: 20px 0;
            }

            .album-art {
                width: var(--album-art-size);
                height: var(--album-art-size);
                border-radius: 15px;
                overflow: hidden;
                box-shadow:
                    8px 8px 15px var(--shadow-dark),
                    -8px -8px 15px var(--shadow-light);
                transition: transform 0.3s ease;
            }

            .album-art:hover {
                transform: scale(1.02);
            }

            .album-art img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .song-info {
                text-align: center;
                margin-bottom: 25px;
                padding: 0 15px;
                width: 100%;
                max-width: 400px;
            }

            .song-title {
                font-size: clamp(16px, 4vw, 22px);
                font-weight: 600;
                margin-bottom: 5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .song-artist {
                font-size: clamp(12px, 3vw, 16px);
                opacity: 0.7;
            }

            .progress-container {
                width: 100%;
                max-width: 400px;
                height: 5px;
                background-color: rgba(0, 0, 0, 0.05);
                border-radius: 2px;
                margin-bottom: 10px;
                cursor: pointer;
                box-shadow:
                    inset 2px 2px 4px var(--shadow-dark),
                    inset -2px -2px 4px var(--shadow-light);
            }

            .progress-bar {
                height: 100%;
                background-color: var(--accent-color);
                border-radius: 2px;
                width: 1%;
                transition: width 0.1s linear;
            }

            .time-display {
                display: flex;
                width: 100%;
                max-width: 400px;
                justify-content: space-between;
                font-size: 12px;
                margin-bottom: 25px;
                opacity: 0.7;
            }

            .controls {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 30px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                box-shadow:
                    5px 5px 10px var(--shadow-dark),
                    -5px -5px 10px var(--shadow-light);
                transition: all 0.2s;
                border: none;
                background-color: var(--primary-color);
                color: var(--text-color);
            }

            .control-btn:active {
                box-shadow:
                    inset 3px 3px 5px var(--shadow-dark),
                    inset -3px -3px 5px var(--shadow-light);
            }

            .play-btn {
                width: 55px;
                height: 55px;
                background-color: var(--accent-color);
                color: white;
                box-shadow:
                    5px 5px 10px var(--shadow-dark),
                    -5px -5px 10px var(--shadow-light),
                    inset 2px 2px 5px rgba(255, 255, 255, 0.3);
            }

            .play-btn:active {
                box-shadow:
                    inset 3px 3px 5px rgba(0, 0, 0, 0.2),
                    inset -3px -3px 5px rgba(255, 255, 255, 0.2);
            }

            .volume-container {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
                padding: 0 15px;
                width: 100%;
                max-width: 400px;
            }

            .volume-icon {
                margin-right: 10px;
                font-size: 16px;
                min-width: 20px;
            }

            .volume-slider {
                flex-grow: 1;
                height: 4px;
                background-color: rgba(0, 0, 0, 0.05);
                border-radius: 2px;
                cursor: pointer;
                box-shadow:
                    inset 2px 2px 4px var(--shadow-dark),
                    inset -2px -2px 4px var(--shadow-light);
                -webkit-appearance: none;
                outline: none;
            }

            .volume-slider::-webkit-slider-thumb {
                appearance: none;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background-color: var(--accent-color);
                cursor: pointer;
            }

            /* 播放列表样式 */
            .playlist {
                height: calc(100% - 20px);
                overflow-y: auto;
                padding-right: 5px;
                -webkit-overflow-scrolling: touch;
            }

            .playlist-item {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow:
                    3px 3px 6px var(--shadow-dark),
                    -3px -3px 6px var(--shadow-light);
            }

            .playlist-item:hover {
                background-color: rgba(0, 0, 0, 0.03);
            }

            .playlist-item.active {
                background-color: var(--accent-color);
                color: white;
                box-shadow:
                    inset 3px 3px 5px rgba(0, 0, 0, 0.2),
                    inset -3px -3px 5px rgba(255, 255, 255, 0.2);
            }

            .playlist-item img {
                width: 45px;
                height: 45px;
                border-radius: 8px;
                margin-right: 15px;
                object-fit: cover;
            }

            .playlist-item-info {
                flex-grow: 1;
                min-width: 0;
            }

            .playlist-item-title {
                font-size: 15px;
                margin-bottom: 3px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .playlist-item-artist {
                font-size: 13px;
                opacity: 0.7;
            }

            .playlist-item.active .playlist-item-artist {
                opacity: 0.9;
            }

            .playlist-item-duration {
                font-size: 13px;
                opacity: 0.7;
                margin-left: 10px;
                white-space: nowrap;
            }

            .playlist-item.active .playlist-item-duration {
                opacity: 0.9;
            }

            /* 音乐源样式 */
            .source-container {
                height: calc(100% - 20px);
                overflow-y: auto;
                padding-right: 5px;
                -webkit-overflow-scrolling: touch;
            }

            .source-section {
                margin-bottom: 25px;
            }

            .source-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 15px;
                color: var(--accent-color);
            }

            .input-group {
                display: flex;
                margin-bottom: 15px;
                width: 100%;
            }

            .url-input {
                flex: 1;
                padding: 12px 15px;
                border: none;
                border-radius: 10px;
                background-color: var(--primary-color);
                box-shadow:
                    inset 3px 3px 5px var(--shadow-dark),
                    inset -3px -3px 5px var(--shadow-light);
                font-size: 14px;
                width: 100%;
            }

            .btn {
                padding: 12px 20px;
                border: none;
                border-radius: 10px;
                background-color: var(--primary-color);
                box-shadow:
                    5px 5px 10px var(--shadow-dark),
                    -5px -5px 10px var(--shadow-light);
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
                font-size: 14px;
                width: 100%;
            }

            .btn:active {
                box-shadow:
                    inset 3px 3px 5px var(--shadow-dark),
                    inset -3px -3px 5px var(--shadow-light);
            }

            .btn-primary {
                background-color: var(--accent-color);
                color: white;
            }

            .file-input {
                display: none;
            }

            .info-text {
                font-size: 13px;
                opacity: 0.7;
                margin-top: 10px;
                line-height: 1.4;
            }

            /* 旋转动画 */
            @keyframes rotate {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            .rotate {
                animation: rotate 20s linear infinite;
            }

            .paused {
                animation-play-state: paused;
            }

            /* 自定义滚动条 */
            ::-webkit-scrollbar {
                width: 5px;
            }

            ::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
                border-radius: 3px;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--accent-color);
                border-radius: 3px;
            }

            /* 空状态提示 */
            .empty-message {
                text-align: center;
                margin-top: 50px;
                font-size: 15px;
                opacity: 0.7;
            }

            /* 加载指示器 */
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(0, 0, 0, 0.1);
                border-radius: 50%;
                border-top-color: var(--accent-color);
                animation: spin 1s ease-in-out infinite;
                margin-left: 10px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* 通知样式 */
            .notification {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 100;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            }

            .notification.show {
                opacity: 1;
            }

            /* 权限请求样式 */
            .permission-request {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding: 20px;
                text-align: center;
            }

            .permission-box {
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 400px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            .permission-title {
                font-size: 18px;
                margin-bottom: 15px;
                color: var(--accent-color);
            }

            .permission-text {
                margin-bottom: 20px;
                line-height: 1.5;
            }

            .permission-buttons {
                display: flex;
                gap: 10px;
                justify-content: center;
            }

            .permission-btn {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: 500;
            }

            .permission-btn.allow {
                background-color: var(--accent-color);
                color: white;
            }

            .permission-btn.deny {
                background-color: #f0f0f0;
                color: #333;
            }

            /* 新增歌词容器样式 */
            .lyrics-container {
                width: 100%;
                max-width: 500px;
                height: 200px;
                overflow-y: auto;
                margin: 20px auto;
                text-align: center;
                padding: 10px;
                border-radius: 10px;
                background-color: var(--card-color);
                box-shadow:
                    inset 3px 3px 5px var(--shadow-dark),
                    inset -3px -3px 5px var(--shadow-light);
            }

            .lyric-line {
                margin: 10px 0;
                color: var(--text-secondary);
                transition: all 0.3s;
            }

            .lyric-line.active {
                color: var(--accent-color);
                font-size: 1.2em;
                font-weight: bold;
            }

            /* 新增历史记录和收藏样式 */
            .history-item,
            .favorite-item {
                display: flex;
                align-items: center;
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 8px;
                background-color: var(--card-color);
                box-shadow:
                    3px 3px 6px var(--shadow-dark),
                    -3px -3px 6px var(--shadow-light);
            }

            /* 新增睡眠定时器控件 */
            .sleep-timer {
                display: flex;
                align-items: center;
                margin-top: 15px;
            }

            /* 新增主题切换按钮 */
            .theme-toggle {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 100;
            }

            /* 虚拟滚动优化 */
            .virtual-scroll-container {
                height: 100%;
                overflow-y: auto;
                position: relative;
            }

            .virtual-scroll-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            /* 音频可视化 */
            .visualizer {
                width: 100%;
                height: 80px;
                margin: 20px 0;
                display: flex;
                align-items: flex-end;
                justify-content: center;
            }

            .visualizer-bar {
                width: 4px;
                margin: 0 2px;
                background-color: var(--accent-color);
                border-radius: 2px;
            }

            /* 响应式调整 */
            @media (min-width: 768px) {
                :root {
                    --album-art-size: min(50vw, 300px);
                }

                .player-container {
                    padding: 20px 40px;
                }

                .controls {
                    gap: 15px;
                }

                .source-container {
                    padding: 0 20px;
                }

                .input-group {
                    flex-direction: row;
                    gap: 10px;
                }

                .btn {
                    width: auto;
                    min-width: 150px;
                }
            }

            @media (min-width: 1024px) {
                :root {
                    --album-art-size: 300px;
                }

                .main-content {
                    padding-bottom: 0;
                }

                .tab-bar {
                    position: relative;
                    max-width: 800px;
                    margin: 20px auto 0;
                    box-shadow: none;
                }

                .tab-content {
                    padding: 20px 40px;
                }
            }
        </style>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>

    <body>
        <!-- 新增主题切换按钮 -->
        <button class="theme-toggle control-btn" id="themeToggle" title="切换主题">
            <i class="fas fa-moon"></i>
        </button>

        <!-- 权限请求对话框 -->
        <div class="permission-request" id="permissionRequest" style="display: none;">
            <div class="permission-box">
                <div class="permission-title">文件访问权限</div>
                <div class="permission-text">
                    为了在下次打开时自动加载您的音乐，我们需要保存文件访问权限。您允许我们记住您选择的音乐文件夹吗？
                </div>
                <div class="permission-buttons">
                    <button class="permission-btn allow" id="allowPermission">允许</button>
                    <button class="permission-btn deny" id="denyPermission">拒绝</button>
                </div>
            </div>
        </div>

        <!-- 通知区域 -->
        <div class="notification" id="notification"></div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 播放器标签页 - 新增歌词和可视化 -->
            <div class="tab-content active" id="player-tab">
                <div class="player-container">
                    <div class="album-art-container">
                        <div class="album-art">
                            <img src="https://picsum.photos/400/400" alt="Album Art" id="albumArt">
                        </div>
                    </div>

                    <div class="song-info">
                        <div class="song-title" id="songTitle">歌曲名称</div>
                        <div class="song-artist" id="songArtist">艺术家</div>
                    </div>

                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>

                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>

                    <div class="controls">
                        <button class="control-btn" id="shuffleBtn" title="随机播放">
                            <i class="fas fa-random"></i>
                        </button>
                        <button class="control-btn" id="prevBtn" title="上一曲">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="control-btn play-btn" id="playBtn" title="播放/暂停">
                            <i class="fas fa-play" id="playIcon"></i>
                        </button>
                        <button class="control-btn" id="nextBtn" title="下一曲">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button class="control-btn" id="repeatBtn" title="循环播放">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="control-btn" id="favoriteBtn" title="收藏">
                            <i class="far fa-heart" id="favoriteIcon"></i>
                        </button>
                    </div>

                    <!-- 新增音频可视化 -->
                    <div class="visualizer" id="visualizer"></div>

                    <!-- 新增歌词容器 -->
                    <div class="lyrics-container" id="lyricsContainer">
                        <div class="lyric-line">暂无歌词</div>
                    </div>

                    <!-- 新增睡眠定时器 -->
                    <div class="sleep-timer">
                        <button class="control-btn" id="sleepTimerBtn" title="睡眠定时器">
                            <i class="fas fa-bed"></i>
                        </button>
                        <select id="sleepTimerSelect" class="control-btn">
                            <option value="0">关闭</option>
                            <option value="5">5分钟</option>
                            <option value="15">15分钟</option>
                            <option value="30">30分钟</option>
                            <option value="60">60分钟</option>
                        </select>
                    </div>

                    <div class="volume-container">
                        <i class="fas fa-volume-up volume-icon"></i>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01"
                            value="0.7">
                    </div>
                </div>
            </div>

            <!-- 播放列表标签页 - 新增虚拟滚动 -->
            <div class="tab-content" id="playlist-tab">
                <div class="virtual-scroll-container" id="playlistScrollContainer">
                    <div class="virtual-scroll-content" id="playlistContent"></div>
                </div>
            </div>

            <!-- 新增历史记录标签页 -->
            <div class="tab-content" id="history-tab">
                <div class="virtual-scroll-container" id="historyScrollContainer">
                    <div class="virtual-scroll-content" id="historyContent"></div>
                </div>
            </div>

            <!-- 新增收藏标签页 -->
            <div class="tab-content" id="favorites-tab">
                <div class="virtual-scroll-container" id="favoritesScrollContainer">
                    <div class="virtual-scroll-content" id="favoritesContent"></div>
                </div>
            </div>

            <!-- 音乐源标签页 -->
            <div class="tab-content" id="source-tab">
                <div class="source-container">
                    <div class="source-section">
                        <div class="source-title">从API获取音乐</div>
                        <div class="input-group">
                            <input type="text" class="url-input" id="apiUrlInput"
                                placeholder="输入API地址 (例如: http://localhost:3000/api/songs)">
                        </div>
                        <button class="btn btn-primary" id="fetchApiBtn">
                            <span id="fetchApiText">获取歌曲</span>
                            <span id="fetchApiSpinner" class="loading" style="display: none;"></span>
                        </button>
                        <div class="info-text">API应返回包含title, artist, src, cover, duration字段的JSON数组</div>
                    </div>

                    <div class="source-section">
                        <div class="source-title">从本地文件夹获取</div>
                        <input type="file" id="fileInput" webkitdirectory directory multiple class="file-input"
                            accept="audio/*">
                        <button class="btn btn-primary" id="selectFolderBtn">
                            <span id="selectFolderText">选择文件夹</span>
                            <span id="selectFolderSpinner" class="loading" style="display: none;"></span>
                        </button>
                        <div class="info-text">支持MP3、WAV、OGG等音频文件，将自动解析元数据获取歌曲信息</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部标签栏 - 新增历史记录和收藏标签 -->
        <div class="tab-bar">
            <div class="tab-item active" data-tab="player-tab">
                <div class="tab-icon"><i class="fas fa-music"></i></div>
                <div>播放器</div>
            </div>
            <div class="tab-item" data-tab="playlist-tab">
                <div class="tab-icon"><i class="fas fa-list"></i></div>
                <div>播放列表</div>
            </div>
            <div class="tab-item" data-tab="history-tab">
                <div class="tab-icon"><i class="fas fa-history"></i></div>
                <div>历史记录</div>
            </div>
            <div class="tab-item" data-tab="favorites-tab">
                <div class="tab-icon"><i class="fas fa-heart"></i></div>
                <div>收藏</div>
            </div>
            <div class="tab-item" data-tab="source-tab">
                <div class="tab-icon"><i class="fas fa-database"></i></div>
                <div>音乐源</div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // DOM元素
                const albumArt = document.getElementById('albumArt');
                const songTitle = document.getElementById('songTitle');
                const songArtist = document.getElementById('songArtist');
                const progressBar = document.getElementById('progressBar');
                const progressContainer = document.getElementById('progressContainer');
                const currentTimeEl = document.getElementById('currentTime');
                const durationEl = document.getElementById('duration');
                const playBtn = document.getElementById('playBtn');
                const playIcon = document.getElementById('playIcon');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const volumeSlider = document.getElementById('volumeSlider');
                const playlistContent = document.getElementById('playlistContent');
                const shuffleBtn = document.getElementById('shuffleBtn');
                const repeatBtn = document.getElementById('repeatBtn');
                const tabItems = document.querySelectorAll('.tab-item');
                const tabContents = document.querySelectorAll('.tab-content');
                const apiUrlInput = document.getElementById('apiUrlInput');
                const fetchApiBtn = document.getElementById('fetchApiBtn');
                const fetchApiText = document.getElementById('fetchApiText');
                const fetchApiSpinner = document.getElementById('fetchApiSpinner');
                const fileInput = document.getElementById('fileInput');
                const selectFolderBtn = document.getElementById('selectFolderBtn');
                const selectFolderText = document.getElementById('selectFolderText');
                const selectFolderSpinner = document.getElementById('selectFolderSpinner');
                const notification = document.getElementById('notification');
                const permissionRequest = document.getElementById('permissionRequest');
                const allowPermissionBtn = document.getElementById('allowPermission');
                const denyPermissionBtn = document.getElementById('denyPermission');
                const themeToggle = document.getElementById('themeToggle');
                const visualizer = document.getElementById('visualizer');
                const lyricsContainer = document.getElementById('lyricsContainer');
                const sleepTimerSelect = document.getElementById('sleepTimerSelect');
                const favoriteBtn = document.getElementById('favoriteBtn');
                const favoriteIcon = document.getElementById('favoriteIcon');
                const historyContent = document.getElementById('historyContent');
                const favoritesContent = document.getElementById('favoritesContent');

                // 音频对象
                const audio = new Audio();
                let isPlaying = false;
                let currentSongIndex = 0;
                let isShuffle = false;
                let isRepeat = false;
                let songs = [];
                let originalPlaylist = [];
                let fileHandles = []; // 存储文件句柄
                let isInitialLoad = true; // 标记是否为初始加载
                let currentLyrics = []; // 当前歌词数据
                let sleepTimer = null; // 睡眠定时器

                // 初始化播放器
                async function initPlayer() {
                    audio.volume = volumeSlider.value;

                    // 事件监听器
                    playBtn.addEventListener('click', togglePlay);
                    prevBtn.addEventListener('click', prevSong);
                    nextBtn.addEventListener('click', nextSong);
                    volumeSlider.addEventListener('input', setVolume);
                    progressContainer.addEventListener('click', setProgress);
                    audio.addEventListener('timeupdate', updateProgress);
                    audio.addEventListener('ended', handleSongEnd);
                    audio.addEventListener('loadedmetadata', updateDuration);
                    audio.addEventListener('error', handleAudioError);
                    shuffleBtn.addEventListener('click', toggleShuffle);
                    repeatBtn.addEventListener('click', toggleRepeat);
                    themeToggle.addEventListener('click', toggleTheme);
                    sleepTimerSelect.addEventListener('change', handleSleepTimerChange);
                    favoriteBtn.addEventListener('click', toggleCurrentFavorite);

                    // 标签切换
                    tabItems.forEach(item => {
                        item.addEventListener('click', () => switchTab(item.dataset.tab));
                    });

                    // 音乐源相关
                    fetchApiBtn.addEventListener('click', fetchSongsFromApi);
                    selectFolderBtn.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', handleFileSelect);
                    allowPermissionBtn.addEventListener('click', allowPermission);
                    denyPermissionBtn.addEventListener('click', denyPermission);

                    // 检查本地存储的API地址
                    const savedApiUrl = localStorage.getItem('musicPlayerApiUrl');
                    if (savedApiUrl) {
                        apiUrlInput.value = savedApiUrl;
                    }

                    // 初始化Web Audio API
                    setupAudioVisualizer();

                    // 尝试加载上次的歌曲
                    await loadSavedSongs();

                    // 标记初始加载完成
                    isInitialLoad = false;
                }

                // 设置音频可视化
                function setupAudioVisualizer() {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    const source = audioContext.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);

                    function visualize() {
                        requestAnimationFrame(visualize);
                        analyser.getByteFrequencyData(dataArray);

                        visualizer.innerHTML = '';

                        const barCount = 50;
                        for (let i = 0; i < barCount; i++) {
                            const index = Math.floor(i * bufferLength / barCount);
                            const value = dataArray[index] / 255;
                            const height = value * 100;

                            const bar = document.createElement('div');
                            bar.className = 'visualizer-bar';
                            bar.style.height = `${height}px`;
                            bar.style.opacity = 0.5 + value * 0.5;
                            visualizer.appendChild(bar);
                        }
                    }

                    visualize();
                }

                // 切换主题
                function toggleTheme() {
                    document.body.classList.toggle('dark-mode');
                    const icon = themeToggle.querySelector('i');
                    if (document.body.classList.contains('dark-mode')) {
                        icon.classList.replace('fa-moon', 'fa-sun');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        icon.classList.replace('fa-sun', 'fa-moon');
                        localStorage.setItem('theme', 'light');
                    }
                }

                // 初始化主题
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
                }

                // 处理音频错误
                function handleAudioError() {
                    console.error('音频加载错误:', audio.error);
                    showNotification('音频加载失败，请尝试播放其他歌曲');
                    nextSong();
                }

                // 从API获取歌曲
                async function fetchSongsFromApi() {
                    const apiUrl = apiUrlInput.value.trim();
                    if (!apiUrl) {
                        showNotification('请输入API地址');
                        return;
                    }

                    try {
                        // 显示加载状态
                        fetchApiText.textContent = '加载中...';
                        fetchApiSpinner.style.display = 'inline-block';
                        fetchApiBtn.disabled = true;

                        const response = await fetch(apiUrl);
                        if (!response.ok) throw new Error(`请求失败: ${response.status}`);

                        const data = await response.json();
                        if (!Array.isArray(data)) throw new Error('API返回的数据不是数组');

                        // 验证必要字段
                        const requiredFields = ['title', 'artist', 'src'];
                        const isValid = data.every(song =>
                            requiredFields.every(field => field in song)
                        );

                        if (!isValid) throw new Error('歌曲数据缺少必要字段');

                        songs = data.map(song => ({
                            title: song.title || '未知歌曲',
                            artist: song.artist || '未知艺术家',
                            src: song.src,
                            cover: song.cover || generateRandomCover(),
                            duration: song.duration || '0:00',
                            lyrics: song.lyrics || ''
                        }));

                        originalPlaylist = [...songs];
                        currentSongIndex = 0;

                        loadSong(currentSongIndex, false); // 不自动播放
                        renderPlaylist();
                        updateActiveSong();
                        switchTab('player-tab');

                        // 保存API地址
                        localStorage.setItem('musicPlayerApiUrl', apiUrl);

                        showNotification(`成功加载 ${songs.length} 首歌曲`);
                    } catch (error) {
                        console.error('获取歌曲时出错:', error);
                        showNotification('获取歌曲失败: ' + error.message);
                    } finally {
                        // 重置按钮状态
                        fetchApiText.textContent = '获取歌曲';
                        fetchApiSpinner.style.display = 'none';
                        fetchApiBtn.disabled = false;
                    }
                }

                // 生成随机封面
                function generateRandomCover() {
                    return `https://picsum.photos/200/200?random=${Math.floor(Math.random() * 1000)}`;
                }

                // 处理本地文件夹选择
                async function handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    const audioFiles = files.filter(file => file.type.startsWith('audio/'));

                    if (audioFiles.length === 0) {
                        showNotification('未找到音频文件');
                        return;
                    }

                    try {
                        // 显示加载状态
                        selectFolderText.textContent = '解析中...';
                        selectFolderSpinner.style.display = 'inline-block';
                        selectFolderBtn.disabled = true;

                        // 解析音频文件
                        songs = await Promise.all(audioFiles.map(parseAudioFile));
                        originalPlaylist = [...songs];
                        currentSongIndex = 0;

                        loadSong(currentSongIndex, false); // 不自动播放
                        renderPlaylist();
                        updateActiveSong();
                        switchTab('player-tab');

                        showNotification(`成功加载 ${songs.length} 首歌曲`);

                        // 检查是否已经获得权限
                        const hasPermission = localStorage.getItem('musicPlayerPermission') === 'granted';

                        // 如果没有权限，显示权限请求
                        if (!hasPermission && window.showDirectoryPicker) {
                            permissionRequest.style.display = 'flex';
                        }
                    } catch (error) {
                        console.error('解析音频文件时出错:', error);
                        showNotification('加载音频文件失败: ' + error.message);
                    } finally {
                        // 重置按钮状态
                        selectFolderText.textContent = '选择文件夹';
                        selectFolderSpinner.style.display = 'none';
                        selectFolderBtn.disabled = false;
                    }
                }

                // 允许权限
                async function allowPermission() {
                    try {
                        permissionRequest.style.display = 'none';

                        // 使用File System Access API获取目录句柄
                        if (window.showDirectoryPicker) {
                            const directoryHandle = await window.showDirectoryPicker({
                                mode: 'read'
                            });

                            // 保存目录句柄
                            localStorage.setItem('musicPlayerPermission', 'granted');
                            localStorage.setItem('musicPlayerDirectory', JSON.stringify({
                                name: directoryHandle.name
                            }));

                            // 存储句柄以便后续使用
                            fileHandles = [directoryHandle];

                            showNotification('已获得文件夹访问权限');
                        }
                    } catch (error) {
                        console.error('获取目录权限时出错:', error);
                        showNotification('获取权限失败: ' + error.message);
                    }
                }

                // 拒绝权限
                function denyPermission() {
                    permissionRequest.style.display = 'none';
                    localStorage.setItem('musicPlayerPermission', 'denied');
                    showNotification('您拒绝了文件夹访问权限');
                }

                // 加载保存的歌曲
                async function loadSavedSongs() {
                    try {
                        const savedPermission = localStorage.getItem('musicPlayerPermission');

                        // 如果用户之前拒绝了权限，不再尝试加载
                        if (savedPermission === 'denied') return;

                        // 检查是否有保存的歌曲数据
                        const savedSongs = localStorage.getItem('musicPlayerSongs');
                        if (savedSongs) {
                            songs = JSON.parse(savedSongs);
                            originalPlaylist = [...songs];

                            if (songs.length > 0) {
                                currentSongIndex = 0;
                                loadSong(currentSongIndex, false); // 不自动播放
                                renderPlaylist();
                                updateActiveSong();
                                showNotification(`已加载上次的 ${songs.length} 首歌曲`);
                            }
                        }

                        // 尝试重新获取目录访问权限
                        if (savedPermission === 'granted' && window.showDirectoryPicker) {
                            try {
                                const directoryHandle = await window.showDirectoryPicker({
                                    mode: 'read'
                                });
                                fileHandles = [directoryHandle];
                            } catch (error) {
                                console.error('重新获取目录权限时出错:', error);
                                localStorage.removeItem('musicPlayerPermission');
                            }
                        }
                    } catch (error) {
                        console.error('加载保存的歌曲时出错:', error);
                    }
                }

                // 解析音频文件获取元数据
                function parseAudioFile(file) {
                    return new Promise((resolve) => {
                        const url = URL.createObjectURL(file);
                        const audio = new Audio();

                        audio.src = url;
                        audio.addEventListener('loadedmetadata', () => {
                            const duration = formatTime(audio.duration);
                            const fileName = file.name.replace(/\.[^/.]+$/, "");
                            const [artist, title] = fileName.split(' - ').map(s => s.trim());

                            resolve({
                                title: title || fileName,
                                artist: artist || '未知艺术家',
                                src: url,
                                cover: generateRandomCover(),
                                duration: duration,
                                file: file // 保存文件对象以便后续使用
                            });
                        });

                        audio.addEventListener('error', () => {
                            resolve({
                                title: file.name.replace(/\.[^/.]+$/, ""),
                                artist: '未知艺术家',
                                src: url,
                                cover: generateRandomCover(),
                                duration: '0:00',
                                file: file
                            });
                        });
                    });
                }

                // 加载歌曲
                function loadSong(index, autoPlay = false) {
                    if (!songs || songs.length === 0) return;

                    const song = songs[index];
                    audio.src = song.src;
                    albumArt.src = song.cover;
                    songTitle.textContent = song.title;
                    songArtist.textContent = song.artist;

                    // 更新收藏按钮状态
                    updateFavoriteButton();

                    // 解析歌词
                    if (song.lyrics) {
                        currentLyrics = parseLyrics(song.lyrics);
                    } else {
                        currentLyrics = [];
                    }
                    updateLyrics(currentLyrics, 0);

                    // 重置旋转动画
                    albumArt.classList.remove('rotate', 'paused');
                    void albumArt.offsetWidth; // 触发重绘
                    albumArt.classList.add('rotate');
                    albumArt.classList.add('paused'); // 初始状态为暂停

                    // 只有在不是初始加载且autoPlay为true时才自动播放
                    if (!isInitialLoad && autoPlay && isPlaying) {
                        playSong();
                    } else {
                        // 确保播放状态正确
                        isPlaying = false;
                        playIcon.classList.replace('fa-pause', 'fa-play');
                    }

                    // 添加到历史记录
                    addToHistory(song);

                    // 保存当前播放列表
                    savePlaylist();
                }

                // 解析歌词
                function parseLyrics(lyricsText) {
                    const lines = lyricsText.split('\n');
                    const result = [];

                    lines.forEach(line => {
                        const match = line.match(/^\[(\d+):(\d+)\.(\d+)\](.*)/);
                        if (match) {
                            const minutes = parseFloat(match[1]);
                            const seconds = parseFloat(match[2]);
                            const milliseconds = parseFloat(match[3]);
                            const text = match[4].trim();

                            const time = minutes * 60 + seconds + milliseconds / 100;
                            result.push({ time, text });
                        }
                    });

                    return result;
                }

                // 更新歌词显示
                function updateLyrics(lyrics, currentTime) {
                    if (!lyrics || lyrics.length === 0) {
                        lyricsContainer.innerHTML = '<div class="lyric-line">暂无歌词</div>';
                        return;
                    }

                    // 查找当前应该显示的歌词
                    let activeIndex = -1;
                    for (let i = 0; i < lyrics.length; i++) {
                        if (lyrics[i].time <= currentTime) {
                            activeIndex = i;
                        } else {
                            break;
                        }
                    }

                    // 只渲染当前行及前后几行
                    const startIdx = Math.max(0, activeIndex - 3);
                    const endIdx = Math.min(lyrics.length - 1, activeIndex + 3);

                    lyricsContainer.innerHTML = '';
                    for (let i = startIdx; i <= endIdx; i++) {
                        const line = document.createElement('div');
                        line.className = 'lyric-line';
                        if (i === activeIndex) line.classList.add('active');
                        line.textContent = lyrics[i].text || '...';
                        lyricsContainer.appendChild(line);
                    }

                    // 自动滚动到当前歌词
                    const activeLine = lyricsContainer.querySelector('.active');
                    if (activeLine) {
                        activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                // 更新收藏按钮状态
                function updateFavoriteButton() {
                    const currentSong = songs[currentSongIndex];
                    if (!currentSong) return;

                    const isFavorite = favorites.some(fav =>
                        fav.title === currentSong.title && fav.artist === currentSong.artist);

                    if (isFavorite) {
                        favoriteIcon.classList.replace('far', 'fas');
                        favoriteIcon.style.color = 'red';
                    } else {
                        favoriteIcon.classList.replace('fas', 'far');
                        favoriteIcon.style.color = '';
                    }
                }

                // 切换当前歌曲收藏状态
                function toggleCurrentFavorite() {
                    const currentSong = songs[currentSongIndex];
                    if (!currentSong) return;

                    const isFavorite = toggleFavorite(currentSong);
                    localStorage.setItem('favorites', JSON.stringify(favorites));

                    if (isFavorite) {
                        showNotification('已添加到收藏');
                        favoriteIcon.classList.replace('far', 'fas');
                        favoriteIcon.style.color = 'red';
                    } else {
                        showNotification('已从收藏移除');
                        favoriteIcon.classList.replace('fas', 'far');
                        favoriteIcon.style.color = '';
                    }

                    renderFavorites();
                }

                // 添加/移除收藏
                function toggleFavorite(song) {
                    const existingIndex = favorites.findIndex(item =>
                        item.title === song.title && item.artist === song.artist);

                    if (existingIndex >= 0) {
                        favorites.splice(existingIndex, 1);
                        return false;
                    } else {
                        favorites.push({
                            title: song.title,
                            artist: song.artist,
                            cover: song.cover,
                            src: song.src
                        });
                        return true;
                    }
                }

                // 渲染收藏列表
                function renderFavorites() {
                    favoritesContent.innerHTML = '';

                    favorites.forEach((item, index) => {
                        const favoriteItem = document.createElement('div');
                        favoriteItem.className = 'favorite-item';
                        favoriteItem.innerHTML = `
                        <img src="${item.cover}" alt="${item.title}" width="40" height="40">
                        <div style="margin-left: 10px; flex-grow: 1;">
                            <div>${item.title}</div>
                            <div style="font-size: 0.8em; opacity: 0.7;">${item.artist}</div>
                        </div>
                        <button class="control-btn play-from-favorites" data-index="${index}">
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                        favoriteItem.querySelector('.play-from-favorites').addEventListener('click', () => {
                            playFromFavorites(index);
                        });
                        favoritesContent.appendChild(favoriteItem);
                    });
                }

                // 从收藏播放
                function playFromFavorites(index) {
                    const favSong = favorites[index];
                    const songIndex = songs.findIndex(song =>
                        song.title === favSong.title && song.artist === favSong.artist);

                    if (songIndex >= 0) {
                        currentSongIndex = songIndex;
                        loadSong(currentSongIndex, true);
                        playSong();
                        updateActiveSong();
                        switchTab('player-tab');
                    } else {
                        showNotification('歌曲不在当前播放列表中');
                    }
                }

                // 添加到历史记录
                function addToHistory(song) {
                    // 避免重复添加
                    const existingIndex = playHistory.findIndex(item =>
                        item.title === song.title && item.artist === song.artist);

                    if (existingIndex >= 0) {
                        playHistory.splice(existingIndex, 1);
                    }

                    playHistory.unshift({
                        title: song.title,
                        artist: song.artist,
                        cover: song.cover,
                        src: song.src,
                        timestamp: Date.now()
                    });

                    // 限制历史记录数量
                    if (playHistory.length > 50) {
                        playHistory.pop();
                    }

                    localStorage.setItem('playHistory', JSON.stringify(playHistory));
                    renderHistory();
                }

                // 渲染历史记录
                function renderHistory() {
                    historyContent.innerHTML = '';

                    playHistory.forEach((item, index) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                        <img src="${item.cover}" alt="${item.title}" width="40" height="40">
                        <div style="margin-left: 10px; flex-grow: 1;">
                            <div>${item.title}</div>
                            <div style="font-size: 0.8em; opacity: 0.7;">${item.artist}</div>
                        </div>
                        <button class="control-btn play-from-history" data-index="${index}">
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                        historyItem.querySelector('.play-from-history').addEventListener('click', () => {
                            playFromHistory(index);
                        });
                        historyContent.appendChild(historyItem);
                    });
                }

                // 从历史记录播放
                function playFromHistory(index) {
                    const historySong = playHistory[index];
                    const songIndex = songs.findIndex(song =>
                        song.title === historySong.title && song.artist === historySong.artist);

                    if (songIndex >= 0) {
                        currentSongIndex = songIndex;
                        loadSong(currentSongIndex, true);
                        playSong();
                        updateActiveSong();
                        switchTab('player-tab');
                    } else {
                        showNotification('歌曲不在当前播放列表中');
                    }
                }

                // 保存播放列表到本地存储
                function savePlaylist() {
                    try {
                        // 只保存必要信息，避免存储整个文件对象
                        const playlistToSave = songs.map(song => ({
                            title: song.title,
                            artist: song.artist,
                            src: song.src,
                            cover: song.cover,
                            duration: song.duration,
                            lyrics: song.lyrics
                        }));

                        localStorage.setItem('musicPlayerSongs', JSON.stringify(playlistToSave));
                    } catch (error) {
                        console.error('保存播放列表时出错:', error);
                    }
                }

                // 渲染播放列表
                function renderPlaylist() {
                    playlistContent.innerHTML = '';

                    songs.forEach((song, index) => {
                        const playlistItem = document.createElement('div');
                        playlistItem.className = 'playlist-item';
                        if (index === currentSongIndex) playlistItem.classList.add('active');
                        playlistItem.innerHTML = `
                        <img src="${song.cover}" alt="${song.title}" width="40" height="40">
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title}</div>
                            <div class="playlist-item-artist">${song.artist}</div>
                        </div>
                        <div class="playlist-item-duration">${song.duration}</div>
                    `;
                        playlistItem.addEventListener('click', () => playSongFromPlaylist(index));
                        playlistContent.appendChild(playlistItem);
                    });
                }

                // 从播放列表播放歌曲
                function playSongFromPlaylist(index) {
                    currentSongIndex = index;
                    loadSong(currentSongIndex, true);
                    playSong();
                    updateActiveSong();
                    switchTab('player-tab');
                }

                // 更新活动歌曲样式
                function updateActiveSong() {
                    const playlistItems = document.querySelectorAll('.playlist-item');
                    playlistItems.forEach((item, index) => {
                        item.classList.toggle('active', index === currentSongIndex);
                    });
                }

                // 播放歌曲
                function playSong() {
                    isPlaying = true;
                    playIcon.classList.replace('fa-play', 'fa-pause');
                    albumArt.classList.remove('paused');

                    audio.play().catch(error => {
                        console.error('播放失败:', error);
                        isPlaying = false;
                        playIcon.classList.replace('fa-pause', 'fa-play');
                        albumArt.classList.add('paused');
                        showNotification('播放失败: ' + error.message);
                    });
                }

                // 暂停歌曲
                function pauseSong() {
                    isPlaying = false;
                    playIcon.classList.replace('fa-pause', 'fa-play');
                    albumArt.classList.add('paused');
                    audio.pause();
                }

                // 切换播放/暂停
                function togglePlay() {
                    if (songs.length === 0) {
                        showNotification('请先添加歌曲');
                        return;
                    }

                    isPlaying ? pauseSong() : playSong();
                }

                // 上一曲
                function prevSong() {
                    if (songs.length === 0) return;

                    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                    loadSong(currentSongIndex, true);
                    updateActiveSong();
                }

                // 下一曲
                function nextSong() {
                    if (songs.length === 0) return;

                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                    loadSong(currentSongIndex, true);
                    updateActiveSong();
                }

                // 歌曲结束处理
                function handleSongEnd() {
                    isRepeat ? (audio.currentTime = 0, audio.play()) : nextSong();
                }

                // 更新进度条
                function updateProgress() {
                    const { duration, currentTime } = audio;
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                    currentTimeEl.textContent = formatTime(currentTime);

                    // 更新歌词
                    updateLyrics(currentLyrics, currentTime);
                }

                // 设置进度
                function setProgress(e) {
                    const width = this.clientWidth;
                    const clickX = e.offsetX;
                    const duration = audio.duration;
                    audio.currentTime = (clickX / width) * duration;
                }

                // 更新歌曲总时长
                function updateDuration() {
                    if (!isNaN(audio.duration)) {
                        durationEl.textContent = formatTime(audio.duration);

                        // 更新播放列表中歌曲的时长
                        if (songs[currentSongIndex]) {
                            songs[currentSongIndex].duration = formatTime(audio.duration);
                            const playlistItems = document.querySelectorAll('.playlist-item');
                            if (playlistItems[currentSongIndex]) {
                                const durationEl = playlistItems[currentSongIndex].querySelector('.playlist-item-duration');
                                if (durationEl) {
                                    durationEl.textContent = formatTime(audio.duration);
                                }
                            }
                        }
                    }
                }

                // 处理睡眠定时器
                function handleSleepTimerChange() {
                    const minutes = parseInt(this.value);

                    if (sleepTimer) {
                        clearTimeout(sleepTimer);
                        sleepTimer = null;
                    }

                    if (minutes > 0) {
                        sleepTimer = setTimeout(() => {
                            pauseSong();
                            showNotification(`睡眠定时器已停止播放`);
                            sleepTimerSelect.value = '0';
                        }, minutes * 60 * 1000);
                        showNotification(`将在${minutes}分钟后停止播放`);
                    }
                }

                // 格式化时间
                function formatTime(seconds) {
                    if (isNaN(seconds)) return '0:00';
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }

                // 设置音量
                function setVolume() {
                    audio.volume = this.value;
                }

                // 切换随机播放
                function toggleShuffle() {
                    if (songs.length === 0) {
                        showNotification('请先添加歌曲');
                        return;
                    }

                    isShuffle = !isShuffle;
                    shuffleBtn.classList.toggle('active', isShuffle);

                    if (isShuffle) {
                        // 保存当前歌曲
                        const currentSong = songs[currentSongIndex];

                        // Fisher-Yates 洗牌算法
                        for (let i = songs.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [songs[i], songs[j]] = [songs[j], songs[i]];
                        }

                        // 将当前歌曲移到第一位
                        const newIndex = songs.indexOf(currentSong);
                        if (newIndex > 0) {
                            [songs[0], songs[newIndex]] = [songs[newIndex], songs[0]];
                        }

                        currentSongIndex = 0;
                        showNotification('随机播放已开启');
                    } else {
                        // 恢复原始顺序
                        songs = [...originalPlaylist];
                        currentSongIndex = songs.findIndex(song =>
                            song.title === songTitle.textContent &&
                            song.artist === songArtist.textContent
                        );
                        if (currentSongIndex === -1) currentSongIndex = 0;
                        showNotification('随机播放已关闭');
                    }

                    renderPlaylist();
                    updateActiveSong();
                    savePlaylist();
                }

                // 切换循环播放
                function toggleRepeat() {
                    isRepeat = !isRepeat;
                    repeatBtn.classList.toggle('active', isRepeat);
                    showNotification(isRepeat ? '循环播放已开启' : '循环播放已关闭');
                }

                // 切换标签页
                function switchTab(tabId) {
                    tabItems.forEach(item => {
                        item.classList.toggle('active', item.dataset.tab === tabId);
                    });

                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === tabId);
                    });
                }

                // 显示通知
                function showNotification(message, duration = 3000) {
                    notification.textContent = message;
                    notification.classList.add('show');

                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, duration);
                }

                // 初始化播放器
                initPlayer();

                // 初始化历史记录和收藏
                const playHistory = JSON.parse(localStorage.getItem('playHistory')) || [];
                const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                renderHistory();
                renderFavorites();
            });
        </script>
    </body>

</html>