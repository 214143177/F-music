<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>F音乐播放器</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <style>
            /* 样式保持不变，仅调整类名命名风格 */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            html {
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background-color: #f5f5f5;
                color: #333;
                height: 100%;
                width: 100%;
                display: flex;
                flex-direction: column;
            }

            .mainCont {
                flex: 1;

            }

            .tabPlayer,
            .tabPlayList,
            .tabSource {
                height: 100%;
                display: flex;
                flex-direction: column;
                background-color: rgba(255, 255, 255, 0.9);
                overflow: hidden;
            }

            .hdrPlayer {
                padding: 15px;
                text-align: center;
                font-size: 1.5rem;
                font-weight: bold;
                color: #1a2a6c;
                border-bottom: 1px solid #eee;
            }

            .cntAlbumArt {
                padding: 20px;
                display: flex;
                justify-content: center;
            }

            .boxAlbumArt {
                width: 250px;
                height: 250px;
                border-radius: 50%;
                overflow: hidden;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
                animation: rotateAlbum 20s linear infinite;
                animation-play-state: paused;
            }

            .boxAlbumArt.playing {
                animation-play-state: running;
            }

            @keyframes rotateAlbum {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            .imgAlbumArt {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .infoSong {
                text-align: center;
                padding: 10px 20px;
            }

            .txtSongTitle {
                font-size: 1.4rem;
                font-weight: bold;
                margin-bottom: 5px;
                color: #1a2a6c;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .txtSongArtist {
                font-size: 1.1rem;
                color: #666;
            }

            .cntProgress {
                padding: 15px 20px;
            }

            .barProgressCont {
                width: 100%;
                height: 6px;
                background-color: #e0e0e0;
                border-radius: 3px;
                cursor: pointer;
                margin-bottom: 5px;
            }

            .barProgress {
                height: 100%;
                background: linear-gradient(to right, #1a2a6c, #b21f1f);
                border-radius: 3px;
                width: 0%;
                transition: width 0.1s linear;
            }

            .txtTimeDisp {
                display: flex;
                justify-content: space-between;
                font-size: 0.9rem;
                color: #666;
            }

            .cntControls {
                display: flex;
                justify-content: center;
                padding: 20px;
                gap: 25px;
            }

            .btnControl {
                background: none;
                border: none;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 1.2rem;
                color: #1a2a6c;
                transition: all 0.3s ease;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                background-color: white;
            }

            .btnControl:hover {
                transform: scale(1.1);
                background-color: #f0f0f0;
            }

            .btnPlay {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
                background: linear-gradient(135deg, #1a2a6c, #b21f1f);
                color: white;
            }

            .cntVolume {
                display: flex;
                align-items: center;
                padding: 10px 30px;
                gap: 15px;
            }

            .icoVolume {
                font-size: 1.2rem;
                color: #1a2a6c;
            }

            .sldVolume {
                flex: 1;
                height: 6px;
                -webkit-appearance: none;
                background: #e0e0e0;
                border-radius: 3px;
                outline: none;
            }

            .sldVolume::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #1a2a6c;
                cursor: pointer;
            }

            .listPlay {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            }

            .itemPlay {
                display: flex;
                padding: 12px 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .itemPlay:hover {
                background-color: #f5f5f5;
            }

            .itemPlay.active {
                background-color: #e3f2fd;
                border-left: 4px solid #1a2a6c;
            }

            .infoPlayItem {
                flex: 1;
                min-width: 0;
            }

            .txtPlayTitle {
                font-weight: 500;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: #1a2a6c;
            }

            .txtPlayArtist {
                font-size: 0.9rem;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .txtPlayDur {
                display: flex;
                align-items: center;
                font-size: 0.9rem;
                color: #888;
                padding-left: 10px;
            }

            .msgEmpty {
                text-align: center;
                padding: 40px 20px;
                color: #888;
                font-size: 1.1rem;
            }

            .cntSource {
                padding: 20px;
                overflow-y: auto;
                height: 100%;
            }

            .secSource {
                background-color: white;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .hdrSource {
                font-size: 1.2rem;
                font-weight: 600;
                margin-bottom: 15px;
                color: #1a2a6c;
            }

            .grpInput {
                margin-bottom: 15px;
            }

            .inpUrl {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                transition: border-color 0.3s;
            }

            .inpUrl:focus {
                outline: none;
                border-color: #1a2a6c;
                box-shadow: 0 0 0 2px rgba(26, 42, 108, 0.2);
            }

            .btnMain {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                background: linear-gradient(135deg, #1a2a6c, #b21f1f);
                color: white;
                width: 100%;
            }

            .btnMain:hover {
                opacity: 0.9;
                transform: translateY(-2px);
            }

            .txtInfo {
                margin-top: 15px;
                font-size: 0.9rem;
                color: #666;
                line-height: 1.5;
            }

            .inpFile {
                display: none;
            }

            .barTab {
                display: flex;
                background-color: white;
                border-top: 1px solid #eee;
                height: 70px;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            }

            .itemTab {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-size: 0.8rem;
                color: #888;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .itemTab.active {
                color: #1a2a6c;
            }

            .itemTab.active .icoTab {
                background-color: #1a2a6c;
                color: white;
                transform: translateY(-5px);
            }

            .icoTab {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 4px;
                font-size: 1.2rem;
                transition: all 0.3s ease;
                background-color: #f0f0f0;
            }

            .dlgPermReq {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .boxPerm {
                background-color: white;
                border-radius: 15px;
                padding: 25px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }

            .hdrPerm {
                font-size: 1.3rem;
                font-weight: bold;
                margin-bottom: 15px;
                color: #1a2a6c;
                text-align: center;
            }

            .txtPerm {
                margin-bottom: 25px;
                line-height: 1.6;
                color: #555;
            }

            .grpPermBtns {
                display: flex;
                gap: 15px;
            }

            .btnPerm {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btnPermAllow {
                background: linear-gradient(135deg, #1a2a6c, #b21f1f);
                color: white;
            }

            .btnPermDeny {
                background-color: #f0f0f0;
                color: #555;
            }

            .msgNotify {
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #1a2a6c;
                color: white;
                padding: 12px 25px;
                border-radius: 30px;
                font-size: 0.95rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                display: none;
                z-index: 1000;
                animation: fadeInOut 3s ease-in-out;
            }

            @keyframes fadeInOut {

                0%,
                100% {
                    opacity: 0;
                    transform: translateX(-50%) translateY(20px);
                }

                10%,
                90% {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }

            .dlgTimer {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .cntTimer {
                background-color: white;
                border-radius: 15px;
                padding: 25px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }

            .hdrTimer {
                font-size: 1.3rem;
                font-weight: bold;
                margin-bottom: 20px;
                color: #1a2a6c;
                text-align: center;
            }

            .optTimer {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .btnTimerOpt {
                padding: 12px;
                background-color: #f0f0f0;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btnTimerOpt:hover {
                background-color: #e0e0e0;
            }

            .grpTimerCust {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            #inpCustTime {
                flex: 1;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
            }

            #btnConfCust {
                padding: 12px 20px;
                background: linear-gradient(135deg, #1a2a6c, #b21f1f);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                cursor: pointer;
            }

            .btnTimerCancel {
                width: 100%;
                padding: 12px;
                background-color: #f0f0f0;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btnTimerCancel:hover {
                background-color: #e0e0e0;
            }

            .aniLoading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                margin-left: 10px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .itemHist {
                display: flex;
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
            }

            .itemHist:hover {
                background-color: #f9f9f9;
            }

            .infoHist {
                flex: 1;
                min-width: 0;
            }

            .txtHistTitle {
                font-weight: 500;
                margin-bottom: 3px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .txtHistArtist {
                font-size: 0.85rem;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .txtHistTime {
                font-size: 0.8rem;
                color: #888;
                display: flex;
                align-items: center;
                padding-left: 10px;
            }
        </style>
    </head>

    <body>
        <!-- 主内容区域 -->
        <div class="mainCont">
            <!-- 播放器标签页 -->
            <div class="tabPlayer" id="tabPlayer">
                <div class="playerCont">
                    <div class="hdrPlayer">F音乐播放器</div>
                    <div class="cntAlbumArt">
                        <div class="boxAlbumArt" id="boxAlbumArt">
                            <img src="https://picsum.photos/400/400" alt="Album Art" class="imgAlbumArt"
                                id="imgAlbumArt">
                        </div>
                    </div>
                    <div class="infoSong">
                        <div class="txtSongTitle" id="txtSongTitle">歌曲名称</div>
                        <div class="txtSongArtist" id="txtSongArtist">艺术家</div>
                    </div>
                </div>

                <div class="cntProgress">
                    <div class="barProgressCont" id="barProgressCont">
                        <div class="barProgress" id="barProgress"></div>
                    </div>
                    <div class="txtTimeDisp">
                        <span id="txtCurTime">0:00</span>
                        <span id="txtDur">0:00</span>
                    </div>
                </div>

                <div class="cntControls">
                    <button class="btnControl" id="btnMode" title="随机播放/单曲循环">
                        <i class="fas fa-random" id="icoMode"></i>
                    </button>
                    <button class="btnControl" id="btnPrev" title="上一曲">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="btnControl btnPlay" id="btnPlay" title="播放/暂停">
                        <i class="fas fa-play" id="icoPlay"></i>
                    </button>
                    <button class="btnControl" id="btnNext" title="下一曲">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="btnControl" id="btnTimer" title="定时">
                        <i class="fas fa-clock"></i>
                    </button>
                </div>

                <div class="cntVolume">
                    <i class="fas fa-volume-up icoVolume"></i>
                    <input type="range" class="sldVolume" id="sldVolume" min="0" max="1" step="0.01" value="1">
                </div>
            </div>

            <!-- 播放列表标签页 -->
            <div class="tabPlayList" id="tabPlayList" style="display: none;">
                <div class="listPlay" id="listPlay">
                    <div class="msgEmpty">暂无歌曲，请先添加音乐源</div>
                </div>
            </div>

            <!-- 音乐源标签页 -->
            <div class="tabSource" id="tabSource" style="display: none;">
                <div class="cntSource">
                    <div class="secSource">
                        <div class="hdrSource">从API获取音乐</div>
                        <div class="grpInput">
                            <input type="text" class="inpUrl" id="inpApiUrl"
                                placeholder="输入API地址 (例如: http://localhost:3000/api/songs)">
                        </div>
                        <button class="btnMain" id="btnFetchApi">
                            <span id="txtFetchApi">获取歌曲</span>
                            <span id="spnFetchLoad" class="aniLoading" style="display: none;"></span>
                        </button>
                        <div class="txtInfo">API应返回包含title, artist, src, cover, duration字段的JSON数组</div>
                    </div>

                    <div class="secSource">
                        <div class="hdrSource">从本地文件夹获取</div>
                        <input type="file" id="inpFile" webkitdirectory directory multiple class="inpFile"
                            accept="audio/*">
                        <button class="btnMain" id="btnSelFolder">
                            <span id="txtSelFolder">选择文件夹</span>
                            <span id="spnSelLoad" class="aniLoading" style="display: none;"></span>
                        </button>
                        <div class="txtInfo">支持MP3、WAV、OGG等音频文件，将自动解析元数据获取歌曲信息</div>
                    </div>

                    <div class="secSource">
                        <div class="hdrSource">播放历史</div>
                        <div id="listHist" class="listPlay">
                            <div class="msgEmpty">暂无播放历史</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部标签栏 -->
        <div class="barTab">
            <div class="itemTab active" data-tab="tabPlayer">
                <div class="icoTab"><i class="fas fa-music"></i></div>
                <div>播放器</div>
            </div>
            <div class="itemTab" data-tab="tabPlayList">
                <div class="icoTab"><i class="fas fa-list"></i></div>
                <div>播放列表</div>
            </div>
            <div class="itemTab" data-tab="tabSource">
                <div class="icoTab"><i class="fas fa-database"></i></div>
                <div>音乐源</div>
            </div>
        </div>

        <!-- 权限请求对话框 -->
        <div class="dlgPermReq" id="dlgPermReq" style="display: none;">
            <div class="boxPerm">
                <div class="hdrPerm">文件访问权限</div>
                <div class="txtPerm">
                    为了在下次打开时自动加载您的音乐，我们需要保存文件访问权限。您允许我们记住您选择的音乐文件夹吗？
                </div>
                <div class="grpPermBtns">
                    <button class="btnPerm btnPermAllow" id="btnAllowPerm">允许</button>
                    <button class="btnPerm btnPermDeny" id="btnDenyPerm">拒绝</button>
                </div>
            </div>
        </div>

        <!-- 通知区域 -->
        <div class="msgNotify" id="msgNotify"></div>

        <!-- 定时设置弹窗 -->
        <div class="dlgTimer" id="dlgTimer" style="display: none;">
            <div class="cntTimer">
                <h3 class="hdrTimer">设置定时关闭</h3>
                <div class="optTimer">
                    <button class="btnTimerOpt" data-time="5">5分钟</button>
                    <button class="btnTimerOpt" data-time="10">10分钟</button>
                    <button class="btnTimerOpt" data-time="15">15分钟</button>
                    <button class="btnTimerOpt" data-time="30">30分钟</button>
                    <button class="btnTimerOpt" data-time="60">1小时</button>
                    <button class="btnTimerOpt" data-time="custom">自定义...</button>
                </div>
                <div class="grpTimerCust" style="display: none;">
                    <input type="number" id="inpCustTime" min="1" max="1440" placeholder="分钟">
                    <button id="btnConfCust">确定</button>
                </div>
                <button class="btnTimerCancel" id="btnCancelTimer">取消</button>
            </div>
        </div>

        <!-- 引入ID3库用于解析元数据 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.7/jsmediatags.min.js"></script>

        <script>
            // 模块化结构
            const MusicPlayer = (function () {
                // 状态变量
                let currentSongIndex = 0;
                let isPlaying = false;
                let audio = new Audio();
                let playMode = 'normal'; // normal, random, loop
                let songList = [];
                let playHistory = [];
                let timerId = null;
                let permissionAuthorized = false;
                let lastFolderHandle = null;

                // DOM元素缓存
                const domElements = {
                    playButton: document.getElementById('btnPlay'),
                    prevButton: document.getElementById('btnPrev'),
                    nextButton: document.getElementById('btnNext'),
                    modeButton: document.getElementById('btnMode'),
                    timerButton: document.getElementById('btnTimer'),
                    albumImage: document.getElementById('imgAlbumArt'),
                    albumContainer: document.getElementById('boxAlbumArt'),
                    songTitle: document.getElementById('txtSongTitle'),
                    songArtist: document.getElementById('txtSongArtist'),
                    progressBar: document.getElementById('barProgress'),
                    progressContainer: document.getElementById('barProgressCont'),
                    currentTimeDisplay: document.getElementById('txtCurTime'),
                    durationDisplay: document.getElementById('txtDur'),
                    volumeSlider: document.getElementById('sldVolume'),
                    playIcon: document.getElementById('icoPlay'),
                    modeIcon: document.getElementById('icoMode'),
                    notificationBox: document.getElementById('msgNotify'),
                    timerDialog: document.getElementById('dlgTimer'),
                    playlistContainer: document.getElementById('listPlay'),
                    historyContainer: document.getElementById('listHist')
                };

                // 显示通知
                function showNotification(message) {
                    const notifyElement = domElements.notificationBox;
                    if (notifyElement) {
                        notifyElement.textContent = message;
                        notifyElement.style.display = 'block';
                        setTimeout(() => {
                            notifyElement.style.display = 'none';
                        }, 3000);
                    }
                }

                // 初始化播放器
                function initializePlayer() {
                    bindAllEventListeners();
                    setupAudioEventHandlers();
                    loadPlayerConfiguration();
                    checkPermissionStatus();

                    // 加载示例歌曲
                    loadSampleSongs();
                }

                // 绑定所有事件监听器
                function bindAllEventListeners() {
                    // 播放控制事件
                    domElements.playButton.addEventListener('click', togglePlayStatus);
                    domElements.prevButton.addEventListener('click', playPreviousSong);
                    domElements.nextButton.addEventListener('click', playNextSong);
                    domElements.modeButton.addEventListener('click', changePlayMode);
                    domElements.timerButton.addEventListener('click', showTimerDialog);

                    // 进度控制事件
                    domElements.progressContainer.addEventListener('click', setProgressPosition);
                    domElements.volumeSlider.addEventListener('input', adjustVolumeLevel);

                    // 标签切换事件
                    document.querySelectorAll('.itemTab').forEach(tabItem => {
                        tabItem.addEventListener('click', function () {
                            const targetTabId = this.getAttribute('data-tab');
                            switchTabContent(targetTabId);
                        });
                    });

                    // 定时器选项事件
                    document.querySelectorAll('.btnTimerOpt').forEach(option => {
                        option.addEventListener('click', function () {
                            const timeValue = this.dataset.time;
                            if (timeValue === 'custom') {
                                document.querySelector('.grpTimerCust').style.display = 'flex';
                            } else {
                                setTimerDuration(parseInt(timeValue));
                            }
                        });
                    });

                    // 自定义定时确认事件
                    document.getElementById('btnConfCust').addEventListener('click', function () {
                        const customTime = parseInt(document.getElementById('inpCustTime').value);
                        if (customTime && customTime > 0) {
                            setTimerDuration(customTime);
                        }
                    });

                    // 关闭定时器弹窗事件
                    document.getElementById('btnCancelTimer').addEventListener('click', function () {
                        domElements.timerDialog.style.display = 'none';
                        document.querySelector('.grpTimerCust').style.display = 'none';
                    });

                    // 权限请求事件
                    document.getElementById('btnAllowPerm').addEventListener('click', function () {
                        permissionAuthorized = true;
                        localStorage.setItem('musicPlayerPerm', 'granted');
                        document.getElementById('dlgPermReq').style.display = 'none';
                        showNotification('权限已允许');
                    });

                    // 拒绝权限事件
                    document.getElementById('btnDenyPerm').addEventListener('click', function () {
                        permissionAuthorized = false;
                        localStorage.setItem('musicPlayerPerm', 'denied');
                        document.getElementById('dlgPermReq').style.display = 'none';
                        showNotification('权限已拒绝');
                    });

                    // API获取歌曲事件
                    document.getElementById('btnFetchApi').addEventListener('click', fetchSongsFromApi);
                    // 文件夹选择事件
                    document.getElementById('btnSelFolder').addEventListener('click', function () {
                        document.getElementById('inpFile').click();
                    });

                    // 文件选择处理事件
                    document.getElementById('inpFile').addEventListener('change', handleFileSelection);
                }

                // 设置音频事件处理器
                function setupAudioEventHandlers() {
                    audio.addEventListener('timeupdate', updateProgressDisplay);
                    audio.addEventListener('ended', handleSongCompletion);
                    audio.addEventListener('loadedmetadata', function () {
                        updateDurationDisplay();
                        // 更新歌曲时长信息
                        if (songList[currentSongIndex]) {
                            songList[currentSongIndex].duration = audio.duration;
                        }
                    });
                }

                // 切换标签内容显示
                function switchTabContent(tabId) {
                    // 隐藏所有标签页
                    document.querySelectorAll('.mainCont > div').forEach(container => {
                        container.style.display = 'none';
                    });

                    // 显示目标标签页
                    document.getElementById(tabId).style.display = 'flex';

                    // 更新标签激活状态
                    document.querySelectorAll('.itemTab').forEach(tabItem => {
                        tabItem.classList.remove('active');
                        if (tabItem.getAttribute('data-tab') === tabId) {
                            tabItem.classList.add('active');
                        }
                    });

                    // 刷新播放列表
                    if (tabId === 'tabPlayList') {
                        renderPlaylist();
                    }
                }

                // 切换播放状态
                function togglePlayStatus() {
                    if (isPlaying) {
                        pausePlayback();
                    } else {
                        startPlayback();
                    }
                }

                // 开始播放
                function startPlayback() {
                    if (songList.length === 0) return;

                    // 加载当前歌曲
                    if (!audio.src) {
                        loadCurrentSong(songList[currentSongIndex]);
                    }

                    audio.play().then(() => {
                        isPlaying = true;
                        domElements.playIcon.classList.replace('fa-play', 'fa-pause');
                        domElements.albumContainer.classList.add('playing');
                        addToPlayHistory(songList[currentSongIndex]);
                    }).catch(error => {
                        showNotification('播放失败: ' + error.message);
                    });
                }

                // 暂停播放
                function pausePlayback() {
                    audio.pause();
                    isPlaying = false;
                    domElements.playIcon.classList.replace('fa-pause', 'fa-play');
                    domElements.albumContainer.classList.remove('playing');
                }

                // 播放上一首歌曲
                function playPreviousSong() {
                    if (songList.length === 0) return;

                    currentSongIndex = (currentSongIndex - 1 + songList.length) % songList.length;
                    loadCurrentSong(songList[currentSongIndex]);
                    startPlayback();
                }

                // 播放下一首歌曲
                function playNextSong() {
                    if (songList.length === 0) return;

                    switch (playMode) {
                        case 'random':
                            currentSongIndex = Math.floor(Math.random() * songList.length);
                            break;
                        case 'loop':
                            // 单曲循环不改变索引
                            break;
                        default:
                            currentSongIndex = (currentSongIndex + 1) % songList.length;
                    }

                    loadCurrentSong(songList[currentSongIndex]);
                    startPlayback();
                }

                // 加载当前歌曲
                function loadCurrentSong(song) {
                    if (!song) return;

                    audio.src = song.src;
                    domElements.songTitle.textContent = song.title;
                    domElements.songArtist.textContent = song.artist;
                    domElements.albumImage.src = song.cover || 'https://picsum.photos/400/400';

                    // 更新播放列表高亮
                    renderPlaylist();
                }

                // 切换播放模式
                function changePlayMode() {
                    const modes = ['normal', 'random', 'loop'];
                    const modeIcons = ['fa-exchange-alt', 'fa-random', 'fa-redo'];
                    const modeTitles = ['顺序播放', '随机播放', '单曲循环'];

                    const currentIndex = modes.indexOf(playMode);
                    playMode = modes[(currentIndex + 1) % modes.length];

                    domElements.modeIcon.className = `fas ${ modeIcons[(currentIndex + 1) % modes.length] }`;
                    domElements.modeButton.title = modeTitles[(currentIndex + 1) % modes.length];

                    showNotification(`已切换至${ modeTitles[(currentIndex + 1) % modes.length] }模式`);
                    savePlayerState();
                }

                // 显示定时器弹窗
                function showTimerDialog() {
                    domElements.timerDialog.style.display = 'block';
                }

                // 设置定时器时长
                function setTimerDuration(minutes) {
                    // 清除现有定时器
                    if (timerId) {
                        clearTimeout(timerId);
                    }

                    const seconds = minutes * 60;
                    timerId = setTimeout(() => {
                        pausePlayback();
                        showNotification(`定时关闭已触发`);
                        domElements.timerDialog.style.display = 'none';
                        document.querySelector('.grpTimerCust').style.display = 'none';
                        timerId = null;
                    }, seconds * 1000);

                    showNotification(`已设置${ minutes }分钟后关闭`);
                    domElements.timerDialog.style.display = 'none';
                    document.querySelector('.grpTimerCust').style.display = 'none';
                }

                // 设置播放进度
                function setProgressPosition(event) {
                    const containerWidth = domElements.progressContainer.clientWidth;
                    const clickPosition = event.offsetX;
                    const totalDuration = audio.duration;

                    if (totalDuration) {
                        audio.currentTime = (clickPosition / containerWidth) * totalDuration;
                    }
                }

                // 更新进度显示
                function updateProgressDisplay() {
                    const progressPercentage = (audio.currentTime / audio.duration) * 100;
                    domElements.progressBar.style.width = `${ progressPercentage }%`;
                    domElements.currentTimeDisplay.textContent = formatTime(audio.currentTime);
                }

                // 更新时长显示
                function updateDurationDisplay() {
                    domElements.durationDisplay.textContent = formatTime(audio.duration);
                }

                // 处理歌曲播放结束
                function handleSongCompletion() {
                    if (playMode === 'loop') {
                        audio.currentTime = 0;
                        audio.play();
                    } else {
                        playNextSong();
                    }
                }

                // 调整音量级别
                function adjustVolumeLevel() {
                    audio.volume = domElements.volumeSlider.value;
                }

                // 格式化时间显示
                function formatTime(seconds) {
                    if (isNaN(seconds)) return '0:00';

                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${ minutes }:${ remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds }`;
                }

                // 渲染播放列表
                function renderPlaylist() {
                    if (!domElements.playlistContainer) return;

                    if (songList.length === 0) {
                        domElements.playlistContainer.innerHTML = '<div class="msgEmpty">暂无歌曲</div>';
                        return;
                    }

                    domElements.playlistContainer.innerHTML = '';

                    songList.forEach((song, index) => {
                        const listItem = document.createElement('div');
                        listItem.className = `itemPlay ${ index === currentSongIndex ? 'active' : '' }`;
                        listItem.dataset.index = index;

                        listItem.innerHTML = `
                                    <div class="infoPlayItem">
                                        <div class="txtPlayTitle">${ song.title }</div>
                                        <div class="txtPlayArtist">${ song.artist }</div>
                                    </div>
                                    <div class="txtPlayDur">${ formatTime(song.duration || 0) }</div>
                                `;

                        listItem.addEventListener('click', () => {
                            currentSongIndex = index;
                            loadCurrentSong(song);
                            startPlayback();
                        });

                        domElements.playlistContainer.appendChild(listItem);
                    });
                }

                // 添加到播放历史
                function addToPlayHistory(song) {
                    // 避免重复添加
                    if (playHistory.length > 0 && playHistory[0].src === song.src) {
                        return;
                    }

                    // 添加到历史记录开头
                    playHistory.unshift({
                        ...song,
                        timestamp: new Date().toLocaleTimeString()
                    });

                    // 限制历史记录数量
                    if (playHistory.length > 10) {
                        playHistory.pop();
                    }

                    renderHistoryList();
                    savePlayerState();
                }

                // 渲染历史记录列表
                function renderHistoryList() {
                    if (!domElements.historyContainer) return;

                    if (playHistory.length === 0) {
                        domElements.historyContainer.innerHTML = '<div class="msgEmpty">暂无播放历史</div>';
                        return;
                    }

                    domElements.historyContainer.innerHTML = '';

                    playHistory.forEach((item, index) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'itemHist';

                        historyItem.innerHTML = `
                                    <div class="infoHist">
                                        <div class="txtHistTitle">${ item.title }</div>
                                        <div class="txtHistArtist">${ item.artist }</div>
                                    </div>
                                    <div class="txtHistTime">${ item.timestamp }</div>
                                `;

                        historyItem.addEventListener('click', () => {
                            // 在播放列表中查找歌曲
                            const songIndex = songList.findIndex(song => song.src === item.src);
                            if (songIndex !== -1) {
                                currentSongIndex = songIndex;
                                loadCurrentSong(songList[songIndex]);
                                startPlayback();
                            } else {
                                showNotification('歌曲不在当前播放列表中');
                            }
                        });

                        domElements.historyContainer.appendChild(historyItem);
                    });
                }

                // 加载播放器状态
                function loadPlayerConfiguration() {
                    const savedState = localStorage.getItem('musicPlayerState');
                    if (savedState) {
                        try {
                            const state = JSON.parse(savedState);
                            songList = state.songs || [];
                            currentSongIndex = state.currentSongIndex || 0;
                            playMode = state.playMode || 'normal';
                            playHistory = state.playHistory || [];

                            // 恢复模式图标
                            const modeIconMap = {
                                'normal': 'fa-exchange-alt',
                                'random': 'fa-random',
                                'loop': 'fa-redo'
                            };

                            if (modeIconMap[playMode]) {
                                domElements.modeIcon.className = `fas ${ modeIconMap[playMode] }`;
                            }

                            // 加载当前歌曲
                            if (songList.length > 0) {
                                loadCurrentSong(songList[currentSongIndex]);
                            }

                            // 渲染历史记录
                            renderHistoryList();
                        } catch (error) {
                            console.error('加载播放器状态失败', error);
                        }
                    }
                }

                // 保存播放器状态
                function savePlayerState() {
                    const state = {
                        songs: songList,
                        currentSongIndex: currentSongIndex,
                        playMode: playMode,
                        playHistory: playHistory
                    };

                    localStorage.setItem('musicPlayerState', JSON.stringify(state));
                }

                // 检查权限状态
                function checkPermissionStatus() {
                    const permissionStatus = localStorage.getItem('musicPlayerPerm');
                    permissionAuthorized = permissionStatus === 'granted';
                }

                // 从API获取歌曲
                async function fetchSongsFromApi() {
                    const apiInput = document.getElementById('inpApiUrl');
                    const apiUrl = apiInput.value.trim();

                    if (!apiUrl) {
                        showNotification('请输入API地址');
                        return;
                    }

                    const fetchButtonText = document.getElementById('txtFetchApi');
                    const loadingSpinner = document.getElementById('spnFetchLoad');

                    try {
                        fetchButtonText.textContent = '获取中...';
                        loadingSpinner.style.display = 'inline-block';

                        const response = await fetch(apiUrl);
                        if (!response.ok) {
                            throw new Error(`HTTP错误! 状态码: ${ response.status }`);
                        }

                        const newSongs = await response.json();
                        if (!Array.isArray(newSongs)) {
                            throw new Error('API返回无效数据格式');
                        }

                        // 添加新歌曲到列表
                        songList = [...songList, ...newSongs];
                        if (songList.length > 0 && !audio.src) {
                            loadCurrentSong(songList[currentSongIndex]);
                        }

                        renderPlaylist();
                        showNotification(`成功添加${ newSongs.length }首歌曲`);
                        savePlayerState();
                    } catch (error) {
                        showNotification('获取歌曲失败: ' + error.message);
                    } finally {
                        fetchButtonText.textContent = '获取歌曲';
                        loadingSpinner.style.display = 'none';
                    }
                }

                // 处理文件选择
                async function handleFileSelection(event) {
                    const selectedFiles = Array.from(event.target.files);
                    const audioFiles = selectedFiles.filter(file => file.type.startsWith('audio/'));

                    if (audioFiles.length === 0) {
                        showNotification('未选择音频文件');
                        return;
                    }

                    const folderButtonText = document.getElementById('txtSelFolder');
                    const folderSpinner = document.getElementById('spnSelLoad');

                    try {
                        folderButtonText.textContent = '处理中...';
                        folderSpinner.style.display = 'inline-block';

                        const newSongs = [];
                        for (const file of audioFiles) {
                            const song = await parseAudioFile(file);
                            newSongs.push(song);
                        }

                        // 添加新歌曲到列表
                        songList = [...songList, ...newSongs];
                        if (songList.length > 0 && !audio.src) {
                            currentSongIndex = 0;
                            loadCurrentSong(songList[0]);
                        }

                        renderPlaylist();
                        showNotification(`成功添加${ newSongs.length }首歌曲`);
                        savePlayerState();

                        // 请求权限
                        if (!permissionAuthorized) {
                            document.getElementById('dlgPermReq').style.display = 'flex';
                        }
                    } catch (error) {
                        showNotification('处理文件失败: ' + error.message);
                    } finally {
                        folderButtonText.textContent = '选择文件夹';
                        folderSpinner.style.display = 'none';
                        event.target.value = '';
                    }
                }

                // 解析音频文件元数据
                function parseAudioFile(file) {
                    return new Promise((resolve, reject) => {
                        const fileUrl = URL.createObjectURL(file);

                        // 使用jsmediatags解析元数据
                        new jsmediatags.Reader(file)
                            .setTagsToRead(['title', 'artist', 'picture'])
                            .read({
                                onSuccess: function (tag) {
                                    const tags = tag.tags;
                                    const title = tags.title || file.name.replace(/\.[^/.]+$/, "");
                                    const artist = tags.artist || '未知艺术家';

                                    // 处理专辑封面
                                    let coverUrl = 'https://picsum.photos/400/400';
                                    if (tags.picture) {
                                        try {
                                            const base64Data = bufferToBase64(tags.picture.data);
                                            coverUrl = `data:${ tags.picture.format };base64,${ base64Data }`;
                                        } catch (error) {
                                            console.error('解析封面失败', error);
                                        }
                                    }

                                    resolve({
                                        title: title,
                                        artist: artist,
                                        src: fileUrl,
                                        cover: coverUrl,
                                        file: file,
                                        duration: 0 // 后续通过音频元素获取
                                    });
                                },
                                onError: function (error) {
                                    console.error('读取标签失败', error);
                                    resolve({
                                        title: file.name.replace(/\.[^/.]+$/, ""),
                                        artist: '未知艺术家',
                                        src: fileUrl,
                                        cover: 'https://picsum.photos/400/400',
                                        file: file,
                                        duration: 0
                                    });
                                }
                            });
                    });
                }

                // ArrayBuffer转Base64
                function bufferToBase64(buffer) {
                    const byteArray = new Uint8Array(buffer);
                    let binaryString = '';
                    for (let i = 0; i < byteArray.byteLength; i++) {
                        binaryString += String.fromCharCode(byteArray[i]);
                    }
                    return window.btoa(binaryString);
                }

                // 加载示例歌曲
                function loadSampleSongs() {
                    if (songList.length > 0) return;

                    const sampleSongs = [
                        {
                            title: '示例歌曲 1',
                            artist: '示例艺术家',
                            src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                            cover: 'https://picsum.photos/400/400?random=1',
                            duration: 217
                        },
                        {
                            title: '示例歌曲 2',
                            artist: '示例艺术家',
                            src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                            cover: 'https://picsum.photos/400/400?random=2',
                            duration: 191
                        },
                        {
                            title: '示例歌曲 3',
                            artist: '示例艺术家',
                            src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
                            cover: 'https://picsum.photos/400/400?random=3',
                            duration: 210
                        }
                    ];

                    songList = sampleSongs;
                    loadCurrentSong(songList[currentSongIndex]);
                    renderPlaylist();
                }

                // 公开API
                return {
                    init: initializePlayer
                };
            })();

            // 初始化播放器
            document.addEventListener('DOMContentLoaded', () => {
                MusicPlayer.init();
            });
        </script>
    </body>

</html>